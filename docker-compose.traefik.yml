version: '3.8'

services:
  telegram-mini-app:
    build: .
    container_name: telegram-mini-app
    restart: unless-stopped
    expose:
      - "80"
    labels:
      # Báº­t Traefik
      - "traefik.enable=true"
      
      # HTTP router
      - "traefik.http.routers.telegram-app.rule=Host(`${TELEGRAM_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.telegram-app.entrypoints=web,websecure"
      - "traefik.http.routers.telegram-app.tls=true"
      - "traefik.http.routers.telegram-app.tls.certresolver=mytlschallenge"
      
      # Middleware cho security headers
      - "traefik.http.middlewares.telegram-app.headers.SSLRedirect=true"
      - "traefik.http.middlewares.telegram-app.headers.STSSeconds=315360000"
      - "traefik.http.middlewares.telegram-app.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.telegram-app.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.telegram-app.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.telegram-app.headers.SSLHost=${DOMAIN_NAME}"
      - "traefik.http.middlewares.telegram-app.headers.STSIncludeSubdomains=true"
      - "traefik.http.middlewares.telegram-app.headers.STSPreload=true"
      - "traefik.http.middlewares.telegram-app.headers.frameDeny=false"
      - "traefik.http.middlewares.telegram-app.headers.contentSecurityPolicy=frame-ancestors 'self' https://web.telegram.org https://telegram.org"
      
      # Apply middleware
      - "traefik.http.routers.telegram-app.middlewares=telegram-app@docker"
      
      # Service
      - "traefik.http.services.telegram-app.loadbalancer.server.port=80"
    
    networks:
      - traefik_default
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  traefik_default:
    external: true