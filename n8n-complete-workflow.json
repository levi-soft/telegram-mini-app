{
  "name": "Telegram Mini App - Full n8n",
  "nodes": [
    {
      "parameters": {
        "path": "app",
        "options": {}
      },
      "id": "webhook-app",
      "name": "Webhook Main App",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "app"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $node[\"Generate HTML\"].json.html }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "response-html",
      "name": "Return HTML",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "functionCode": "// HTML template ƒë·∫ßy ƒë·ªß cho Telegram Mini App\nconst html = `\n<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n    <title>Qu·∫£n L√Ω T√†i S·∫£n</title>\n    <script src=\"https://telegram.org/js/telegram-web-app.js\"></script>\n    <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background: #f5f5f5;\n            padding: 20px;\n        }\n        .container { max-width: 600px; margin: 0 auto; }\n        .header {\n            background: linear-gradient(135deg, #2481cc, #5ba3d8);\n            color: white;\n            padding: 30px 20px;\n            border-radius: 12px;\n            text-align: center;\n            margin-bottom: 20px;\n        }\n        .form-group {\n            margin-bottom: 15px;\n        }\n        .form-group label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: 600;\n        }\n        .form-group input, .form-group select, .form-group textarea {\n            width: 100%;\n            padding: 12px;\n            border: 2px solid #e0e0e0;\n            border-radius: 8px;\n            font-size: 16px;\n        }\n        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {\n            outline: none;\n            border-color: #2481cc;\n        }\n        .btn {\n            width: 100%;\n            padding: 15px;\n            background: #2481cc;\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 16px;\n            font-weight: bold;\n            cursor: pointer;\n            margin-top: 10px;\n        }\n        .btn:hover { background: #1a6ba8; }\n        .btn:disabled {\n            background: #ccc;\n            cursor: not-allowed;\n        }\n        .section {\n            background: white;\n            padding: 20px;\n            border-radius: 12px;\n            margin-bottom: 15px;\n        }\n        .menu-btn {\n            width: 100%;\n            padding: 20px;\n            background: white;\n            border: 2px solid #e0e0e0;\n            border-radius: 12px;\n            cursor: pointer;\n            text-align: left;\n            margin-bottom: 15px;\n        }\n        .menu-btn:hover {\n            border-color: #2481cc;\n        }\n        .item {\n            padding: 15px;\n            background: white;\n            border-radius: 8px;\n            margin-bottom: 10px;\n            border-left: 4px solid #2481cc;\n        }\n        .hidden { display: none; }\n    </style>\n</head>\n<body>\n    <div class=\"container\" id=\"app\">\n        <div class=\"header\">\n            <h1>üì¶ Qu·∫£n L√Ω T√†i S·∫£n</h1>\n            <p>H·ªá th·ªëng qu·∫£n l√Ω h√†ng h√≥a c√¥ng ty</p>\n        </div>\n\n        <!-- Menu -->\n        <div id=\"menu-page\">\n            <button class=\"menu-btn\" onclick=\"showPage('import-page')\">\n                <div style=\"font-size: 24px; margin-bottom: 10px;\">üì•</div>\n                <div style=\"font-size: 18px; font-weight: bold;\">Nh·∫≠p H√†ng</div>\n                <div style=\"color: #666; font-size: 14px;\">Ghi nh·∫≠n h√†ng h√≥a nh·∫≠p kho</div>\n            </button>\n            <button class=\"menu-btn\" onclick=\"showPage('check-page')\">\n                <div style=\"font-size: 24px; margin-bottom: 10px;\">‚úÖ</div>\n                <div style=\"font-size: 18px; font-weight: bold;\">Ki·ªÉm H√†ng</div>\n                <div style=\"color: #666; font-size: 14px;\">Ki·ªÉm tra t·ªìn kho</div>\n            </button>\n            <button class=\"menu-btn\" onclick=\"showPage('list-page')\">\n                <div style=\"font-size: 24px; margin-bottom: 10px;\">üìã</div>\n                <div style=\"font-size: 18px; font-weight: bold;\">Danh S√°ch</div>\n                <div style=\"color: #666; font-size: 14px;\">Xem t·∫•t c·∫£ phi·∫øu nh·∫≠p</div>\n            </button>\n        </div>\n\n        <!-- Nh·∫≠p H√†ng -->\n        <div id=\"import-page\" class=\"hidden\">\n            <button class=\"btn\" style=\"background: #666; margin-bottom: 15px;\" onclick=\"showPage('menu-page')\">‚Üê Quay l·∫°i</button>\n            <div class=\"section\">\n                <h2 style=\"margin-bottom: 15px;\">Nh·∫≠p H√†ng</h2>\n                <form id=\"import-form\">\n                    <div class=\"form-group\">\n                        <label>T√™n s·∫£n ph·∫©m *</label>\n                        <input type=\"text\" id=\"product-name\" required>\n                    </div>\n                    <div class=\"form-group\">\n                        <label>M√£ s·∫£n ph·∫©m *</label>\n                        <input type=\"text\" id=\"product-code\" required>\n                    </div>\n                    <div class=\"form-group\">\n                        <label>S·ªë l∆∞·ª£ng *</label>\n                        <input type=\"number\" id=\"quantity\" required min=\"1\">\n                    </div>\n                    <div class=\"form-group\">\n                        <label>ƒê∆°n v·ªã *</label>\n                        <select id=\"unit\" required>\n                            <option value=\"c√°i\">C√°i</option>\n                            <option value=\"chi·∫øc\">Chi·∫øc</option>\n                            <option value=\"h·ªôp\">H·ªôp</option>\n                            <option value=\"th√πng\">Th√πng</option>\n                            <option value=\"kg\">Kg</option>\n                        </select>\n                    </div>\n                    <div class=\"form-group\">\n                        <label>Nh√† cung c·∫•p</label>\n                        <input type=\"text\" id=\"supplier\">\n                    </div>\n                    <div class=\"form-group\">\n                        <label>Ng√†y nh·∫≠p *</label>\n                        <input type=\"date\" id=\"import-date\" required>\n                    </div>\n                    <button type=\"submit\" class=\"btn\">üíæ L∆∞u phi·∫øu nh·∫≠p</button>\n                </form>\n            </div>\n        </div>\n\n        <!-- Danh s√°ch -->\n        <div id=\"list-page\" class=\"hidden\">\n            <button class=\"btn\" style=\"background: #666; margin-bottom: 15px;\" onclick=\"showPage('menu-page')\">‚Üê Quay l·∫°i</button>\n            <div class=\"section\">\n                <h2 style=\"margin-bottom: 15px;\">Danh S√°ch H√†ng H√≥a</h2>\n                <div id=\"list-container\">ƒêang t·∫£i...</div>\n            </div>\n        </div>\n\n        <!-- Ki·ªÉm h√†ng -->\n        <div id=\"check-page\" class=\"hidden\">\n            <button class=\"btn\" style=\"background: #666; margin-bottom: 15px;\" onclick=\"showPage('menu-page')\">‚Üê Quay l·∫°i</button>\n            <div class=\"section\">\n                <h2 style=\"margin-bottom: 15px;\">Ki·ªÉm H√†ng</h2>\n                <div id=\"check-list\">ƒêang t·∫£i...</div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        const tg = window.Telegram.WebApp;\n        tg.expand();\n        tg.ready();\n\n        const BASE_URL = 'https://n8n.tayninh.cloud/webhook';\n        const user = tg.initDataUnsafe?.user || { id: 'test', first_name: 'Test' };\n\n        function showPage(pageId) {\n            document.querySelectorAll('[id$=\"-page\"]').forEach(p => p.classList.add('hidden'));\n            document.getElementById(pageId).classList.remove('hidden');\n            \n            if (pageId === 'list-page') loadList();\n            if (pageId === 'check-page') loadCheckList();\n            if (pageId === 'import-page') setToday();\n        }\n\n        function setToday() {\n            document.getElementById('import-date').value = new Date().toISOString().split('T')[0];\n        }\n\n        document.getElementById('import-form').addEventListener('submit', async (e) => {\n            e.preventDefault();\n            const btn = e.target.querySelector('button');\n            btn.disabled = true;\n            btn.textContent = '‚è≥ ƒêang l∆∞u...';\n\n            const data = {\n                product_name: document.getElementById('product-name').value,\n                product_code: document.getElementById('product-code').value,\n                quantity: parseInt(document.getElementById('quantity').value),\n                unit: document.getElementById('unit').value,\n                supplier: document.getElementById('supplier').value || '',\n                import_date: document.getElementById('import-date').value,\n                telegram_user_id: user.id.toString(),\n                telegram_user_name: user.first_name\n            };\n\n            try {\n                const res = await fetch(BASE_URL + '/nhap-hang', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(data)\n                });\n                \n                if (res.ok) {\n                    tg.showAlert('‚úÖ ƒê√£ l∆∞u: ' + data.product_name);\n                    e.target.reset();\n                    setToday();\n                    showPage('menu-page');\n                } else {\n                    throw new Error('Failed');\n                }\n            } catch (err) {\n                tg.showAlert('‚ùå L·ªói khi l∆∞u!');\n            } finally {\n                btn.disabled = false;\n                btn.textContent = 'üíæ L∆∞u phi·∫øu nh·∫≠p';\n            }\n        });\n\n        async function loadList() {\n            try {\n                const res = await fetch(BASE_URL + '/danh-sach');\n                const result = await res.json();\n                const list = result.data || [];\n                \n                if (list.length === 0) {\n                    document.getElementById('list-container').innerHTML = '<p style=\"text-align:center; color:#999;\">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';\n                    return;\n                }\n                \n                document.getElementById('list-container').innerHTML = list.map(item => `\n                    <div class=\"item\">\n                        <div style=\"font-weight:bold;\">${item.product_name}</div>\n                        <div style=\"color:#666; font-size:14px;\">M√£: ${item.product_code} ‚Ä¢ ${item.quantity} ${item.unit}</div>\n                        <div style=\"color:#999; font-size:12px;\">üìÖ ${item.import_date}</div>\n                    </div>\n                `).join('');\n            } catch (err) {\n                document.getElementById('list-container').innerHTML = '<p style=\"color:red;\">L·ªói t·∫£i d·ªØ li·ªáu</p>';\n            }\n        }\n\n        async function loadCheckList() {\n            try {\n                const res = await fetch(BASE_URL + '/danh-sach');\n                const result = await res.json();\n                const list = (result.data || []).filter(i => i.status === 'pending');\n                \n                if (list.length === 0) {\n                    document.getElementById('check-list').innerHTML = '<p style=\"text-align:center; color:#999;\">Kh√¥ng c√≥ h√†ng c·∫ßn ki·ªÉm</p>';\n                    return;\n                }\n                \n                document.getElementById('check-list').innerHTML = list.map(item => `\n                    <div class=\"item\" onclick=\"checkItem(${item.id}, '${item.product_name}', ${item.quantity})\">\n                        <div style=\"font-weight:bold;\">${item.product_name}</div>\n                        <div style=\"color:#666; font-size:14px;\">M√£: ${item.product_code} ‚Ä¢ ${item.quantity} ${item.unit}</div>\n                        <div style=\"color:#ff9800; font-size:12px;\">‚è≥ Ch·ªù ki·ªÉm tra</div>\n                    </div>\n                `).join('');\n            } catch (err) {\n                document.getElementById('check-list').innerHTML = '<p style=\"color:red;\">L·ªói t·∫£i d·ªØ li·ªáu</p>';\n            }\n        }\n\n        async function checkItem(id, name, qty) {\n            const actual = prompt('S·ªë l∆∞·ª£ng th·ª±c t·∫ø:', qty);\n            if (!actual) return;\n            \n            const data = {\n                id: id,\n                actual_quantity: parseInt(actual),\n                condition: 'good',\n                check_notes: '',\n                telegram_user_id: user.id.toString(),\n                telegram_user_name: user.first_name\n            };\n\n            try {\n                const res = await fetch(BASE_URL + '/kiem-hang', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(data)\n                });\n                \n                if (res.ok) {\n                    tg.showAlert('‚úÖ ƒê√£ ki·ªÉm: ' + name);\n                    loadCheckList();\n                } else {\n                    throw new Error('Failed');\n                }\n            } catch (err) {\n                tg.showAlert('‚ùå L·ªói khi ki·ªÉm!');\n            }\n        }\n\n        setToday();\n    </script>\n</body>\n</html>\n`;\n\nreturn [{ json: { html } }];"
      },
      "id": "generate-html",
      "name": "Generate HTML",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "path": "nhap-hang",
        "options": {}
      },
      "id": "webhook-nhap-hang",
      "name": "API Nh·∫≠p H√†ng",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 500],
      "webhookId": "nhap-hang"
    },
    {
      "parameters": {
        "operation": "create",
        "dataTableName": "inventory_imports",
        "values": "={{ $json }}"
      },
      "id": "save-import",
      "name": "Save to Table",
      "type": "n8n-nodes-base.internalTable",
      "typeVersion": 1,
      "position": [460, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true } }}"
      },
      "id": "response-save",
      "name": "Response OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 500]
    },
    {
      "parameters": {
        "path": "kiem-hang",
        "options": {}
      },
      "id": "webhook-check",
      "name": "API Ki·ªÉm H√†ng",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 700],
      "webhookId": "kiem-hang"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableName": "inventory_imports",
        "filterOptions": {
          "conditions": [
            {
              "column": "id",
              "operator": "equals",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "values": {
          "status": "checked",
          "actual_quantity": "={{ $json.actual_quantity }}",
          "condition": "={{ $json.condition }}",
          "check_notes": "={{ $json.check_notes }}",
          "checked_by_user_id": "={{ $json.telegram_user_id }}",
          "checked_by_user_name": "={{ $json.telegram_user_name }}",
          "check_date": "={{ $now.toISO() }}"
        }
      },
      "id": "update-check",
      "name": "Update Check",
      "type": "n8n-nodes-base.internalTable",
      "typeVersion": 1,
      "position": [460, 700]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true } }}"
      },
      "id": "response-check",
      "name": "Response Check OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 700]
    },
    {
      "parameters": {
        "path": "danh-sach",
        "options": {}
      },
      "id": "webhook-list",
      "name": "API Danh S√°ch",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 900],
      "webhookId": "danh-sach"
    },
    {
      "parameters": {
        "operation": "getAll",
        "dataTableName": "inventory_imports",
        "returnAll": true,
        "options": {}
      },
      "id": "get-all",
      "name": "Get All Data", 
      "type": "n8n-nodes-base.internalTable",
      "typeVersion": 1,
      "position": [460, 900]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, data: $json } }}"
      },
      "id": "response-list",
      "name": "Response List",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 900]
    }
  ],
  "connections": {
    "Webhook Main App": {
      "main": [[{ "node": "Generate HTML", "type": "main", "index": 0 }]]
    },
    "Generate HTML": {
      "main": [[{ "node": "Return HTML", "type": "main", "index": 0 }]]
    },
    "API Nh·∫≠p H√†ng": {
      "main": [[{ "node": "Save to Table", "type": "main", "index": 0 }]]
    },
    "Save to Table": {
      "main": [[{ "node": "Response OK", "type": "main", "index": 0 }]]
    },
    "API Ki·ªÉm H√†ng": {
      "main": [[{ "node": "Update Check", "type": "main", "index": 0 }]]
    },
    "Update Check": {
      "main": [[{ "node": "Response Check OK", "type": "main", "index": 0 }]]
    },
    "API Danh S√°ch": {
      "main": [[{ "node": "Get All Data", "type": "main", "index": 0 }]]
    },
    "Get All Data": {
      "main": [[{ "node": "Response List", "type": "main", "index": 0 }]]
    }
  }
}