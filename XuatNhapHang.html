<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xu·∫•t Nh·∫≠p H√†ng - RR88/XX88/MM88</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ============================================
           üçé APPLE DESIGN SYSTEM - RESET & BASE
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* üé® Apple iOS Colors - Light Mode */
            --apple-blue: #007AFF;
            --apple-purple: #5856D6;
            --apple-green: #34C759;
            --apple-orange: #FF9500;
            --apple-red: #FF3B30;
            --apple-pink: #FF2D55;
            --apple-teal: #5AC8FA;
            --apple-yellow: #FFCC00;
            
            /* üé≠ Semantic Colors */
            --primary: var(--apple-blue);
            --secondary: var(--apple-purple);
            --success: var(--apple-green);
            --warning: var(--apple-orange);
            --danger: var(--apple-red);
            
            /* üìÑ Backgrounds - Light (Darker for better contrast) */
            --bg-primary: #E5E5EA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F2F2F7;
            --bg-elevated: rgba(255, 255, 255, 0.95);
            --bg-frosted: rgba(255, 255, 255, 0.8);
            
            /* üìù Text Colors - Light */
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #6C6C70;
            --text-quaternary: #AEAEB2;
            
            /* üé® UI Elements */
            --separator: rgba(60, 60, 67, 0.18);
            --border: rgba(0, 0, 0, 0.08);
            
            /* üåì Shadows - Soft Apple Style */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.08);
            
            /* üìê Spacing - 8pt Grid (Compact) */
            --space-xs: 6px;
            --space-sm: 12px;
            --space-md: 18px;
            --space-lg: 24px;
            --space-xl: 32px;

            /* üî§ Typography */
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            --border-radius: 10px;
            --border-radius-lg: 16px;
        }

        /* üåô Dark Mode - Apple Style */
        [data-theme="dark"] {
            /* üìÑ Backgrounds - Dark */
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: #2C2C2E;
            --bg-elevated: rgba(28, 28, 30, 0.9);
            --bg-frosted: rgba(28, 28, 30, 0.72);
            
            /* üìù Text Colors - Dark */
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF5;
            --text-tertiary: #AEAEB2;
            --text-quaternary: #6C6C70;
            
            /* üé® UI Elements - Dark */
            --separator: rgba(235, 235, 245, 0.12);
            --border: rgba(255, 255, 255, 0.04);
            
            /* üåì Shadows - Dark Mode */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           üéØ BASE STYLES
           ============================================ */
        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        /* ============================================
           üì± HEADER - Frosted Glass Style
           ============================================ */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-frosted);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: var(--space-sm);
            border-bottom: 1px solid var(--separator);
            animation: slideDown 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 3px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* üîò Page Selector - iOS Style Pills (Enhanced) */
        .page-selector {
            display: flex;
            gap: 5px;
            margin-top: var(--space-sm);
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .page-btn {
            flex: 1;
            padding: 12px 10px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-tertiary);
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            min-height: 44px;
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        /* ============================================
           üß≠ NAVIGATION - iOS Tab Bar Style
           ============================================ */
        .nav {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: var(--space-sm);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--separator);
        }

        .nav-btn {
            padding: 14px 12px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-height: 78px;
        }

        .nav-btn:active {
            transform: scale(0.96);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn-icon {
            font-size: 28px;
            line-height: 1;
        }

        .nav-btn-text {
            font-size: 12px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* ============================================
           üì¶ CONTENT & SECTIONS
           ============================================ */
        .content {
            padding: var(--space-sm);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* üé¥ Card - Liquid Glass Morphism */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            pointer-events: none;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: var(--space-sm);
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        /* ============================================
           üìù FORMS - Apple iOS Style
           ============================================ */
        .form-group {
            margin-bottom: var(--space-sm);
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            letter-spacing: -0.2px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--separator);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        select.form-control {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23007AFF' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        /* ============================================
           üîò BUTTONS - iOS Style
           ============================================ */
        .btn {
            padding: 13px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            width: 100%;
            min-height: 46px;
            letter-spacing: -0.3px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--separator);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-sm {
            padding: 9px 14px;
            font-size: 14px;
            min-height: 38px;
            border-radius: 8px;
        }

        /* ============================================
           üìä STATS GRID - Apple Cards
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: var(--space-sm);
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--space-sm);
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            transition: transform 0.2s ease;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-card.success {
            border-left: 3px solid var(--success);
        }

        .stat-card.danger {
            border-left: 3px solid var(--danger);
        }

        .stat-card.info {
            border-left: 3px solid var(--primary);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ============================================
           üìã LIST ITEMS - iOS Style
           ============================================ */
        .list-item {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--space-sm);
            margin-bottom: 10px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .list-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            pointer-events: none;
        }

        .list-item:active {
            transform: scale(0.98);
        }

        .list-item.nhap {
            border-left: 3px solid var(--success);
        }

        .list-item.xuat {
            border-left: 3px solid var(--danger);
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 16px;
            letter-spacing: -0.3px;
        }

        .list-item-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .badge-nhap {
            background: var(--success);
        }

        .badge-xuat {
            background: var(--danger);
        }

        .list-item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ============================================
           üîç SEARCH BOX
           ============================================ */
        .search-box {
            position: relative;
            margin-bottom: var(--space-sm);
        }

        .search-input {
            width: 100%;
            padding: 12px 44px 12px 40px;
            border: 1px solid var(--separator);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-tertiary);
        }

        /* ============================================
           ‚è≥ LOADING & TOAST
           ============================================ */
        .loading {
            display: none;
            text-align: center;
            padding: var(--space-lg);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--separator);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-frosted);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 90%;
            border: 1px solid var(--separator);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast-icon {
            font-size: 22px;
        }

        .toast-message {
            font-weight: 500;
            font-size: 15px;
        }

        .toast-success {
            border-left: 3px solid var(--success);
        }

        .toast-error {
            border-left: 3px solid var(--danger);
        }

        .toast-info {
            border-left: 3px solid var(--primary);
        }

        /* ============================================
           ‚ùå EMPTY STATE
           ============================================ */
        .empty-state {
            text-align: center;
            padding: var(--space-xl) var(--space-md);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-sm);
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 17px;
            font-weight: 500;
        }

        /* ============================================
           ü™ü MODAL - Apple Style
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 999;
            animation: fadeIn 0.2s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-md);
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--space-md);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--separator);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.4px;
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--separator);
        }

        .modal-close:active {
            transform: scale(0.9);
        }

        /* ============================================
           üìä TABLE - iOS Style
           ============================================ */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--border-radius);
        }

        .inventory-table {
            width: 100%;
            min-width: 320px;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
        }

        .inventory-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 8px 6px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 1px solid var(--separator);
            white-space: nowrap;
        }

        .inventory-table td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--separator);
            font-size: 13px;
        }

        .inventory-table tr:last-child td {
            border-bottom: none;
        }

        /* ============================================
           üé® DASHBOARD NEW STYLES
           ============================================ */
        .time-filter-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .time-filter-btn {
            padding: 12px 8px;
            border: 1px solid var(--separator);
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-height: 62px;
            position: relative;
            overflow: hidden;
        }

        .time-filter-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .time-filter-btn:hover::before {
            opacity: 1;
        }

        .time-filter-btn:active {
            transform: scale(0.96);
        }

        .time-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .filter-icon {
            font-size: 20px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
        }

        .filter-sublabel {
            font-size: 9px;
            opacity: 0.75;
        }

        .time-range-display {
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
        }

        /* Summary Cards - ULTRA COMPACT */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 5px 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            border-top: 2px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            pointer-events: none;
        }

        .summary-card.success {
            border-top-color: var(--success);
        }

        .summary-card.danger {
            border-top-color: var(--danger);
        }

        .summary-icon {
            font-size: 14px;
        }

        .summary-label {
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .summary-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .summary-trend {
            font-size: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .summary-trend.up {
            color: var(--success);
        }

        .summary-trend.down {
            color: var(--danger);
        }

        .summary-trend.neutral {
            color: var(--text-tertiary);
        }

        /* Chart Styles */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .chart-toggle {
            display: flex;
            gap: 6px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--separator);
        }

        .chart-toggle-btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .chart-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .chart-canvas-wrapper {
            position: relative;
            height: 380px;
            margin-bottom: var(--space-sm);
        }

        .detail-table {
            width: 100%;
            min-width: 320px;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .detail-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 8px 6px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 1px solid var(--separator);
            white-space: nowrap;
        }

        .detail-table td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--separator);
            font-size: 13px;
        }

        .detail-table tr:last-child td {
            border-bottom: none;
        }

        .product-name {
            font-weight: 600;
        }

        .quantity-nhap {
            color: var(--success);
            font-weight: 600;
        }

        .quantity-xuat {
            color: var(--danger);
            font-weight: 600;
        }

        .quantity-net {
            font-weight: 700;
        }

        .quantity-net.positive {
            color: var(--success);
        }

        .quantity-net.negative {
            color: var(--danger);
        }

        /* Google Sheet Sync Styles */
        .sync-progress {
            text-align: center;
            padding: var(--space-lg);
        }

        .sync-icon {
            font-size: 64px;
            margin-bottom: var(--space-sm);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .sync-message {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .gsheet-info {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: var(--space-sm);
            margin: var(--space-md) 0;
            text-align: left;
            border: 1px solid var(--border);
        }

        /* ============================================
           üìÖ DATE SECTION HEADER - iOS Style
           ============================================ */
        .date-section {
            margin-bottom: 12px;
        }

        .date-header {
            position: sticky;
            top: 128px;
            background: var(--bg-frosted);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: 10px 16px;
            margin-bottom: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.2px;
            border: 1px solid var(--separator);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-icon {
            font-size: 16px;
        }

        .date-transactions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ============================================
           üõ†Ô∏è ACTION BUTTONS - iOS Style
           ============================================ */
        .action-btns {
            display: flex;
            gap: 6px;
        }

        /* ============================================
           üì¶ BULK IMPORT/EXPORT STYLES
           ============================================ */
        .bulk-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--separator);
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .bulk-item-name {
            font-weight: 600;
            font-size: 14px;
        }

        .bulk-item-quantity {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bulk-qty-input {
            width: 70px;
            padding: 6px 8px;
            border: 1px solid var(--separator);
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .bulk-remove-btn {
            padding: 6px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            min-width: 32px;
            min-height: 32px;
        }

        .bulk-add-row {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--separator);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: var(--primary);
        }

        .bulk-add-row:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .bulk-summary {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px;
            margin: 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .bulk-summary-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .bulk-summary-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        /* ============================================
           üåô DARK MODE TEXT FIX
           ============================================ */
        [data-theme="dark"] .nav-btn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .nav-btn.active {
            color: white;
        }

        [data-theme="dark"] .page-btn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .page-btn.active {
            color: white !important;
        }

        [data-theme="dark"] .time-filter-btn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .time-filter-btn.active {
            color: white;
        }

        [data-theme="dark"] .chart-toggle-btn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .chart-toggle-btn.active {
            color: white;
        }

        /* ============================================
           üì± RESPONSIVE - Mobile First
           ============================================ */
        @media (max-width: 480px) {
            .header {
                padding: 14px;
            }
            
            .header-title {
                font-size: 20px;
            }
            
            .nav {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 8px;
            }
            
            .nav-btn {
                min-height: 78px;
                padding: 12px 8px;
            }

            .nav-btn-icon {
                font-size: 26px;
            }

            .nav-btn-text {
                font-size: 11px;
            }
            
            .content {
                padding: 12px;
            }
            
            .card {
                padding: var(--space-sm);
            }
            
            .summary-grid {
                gap: 8px;
            }
            
            .summary-card {
                padding: 12px 10px;
            }

            .summary-value {
                font-size: 16px;
            }
            
            .chart-canvas-wrapper {
                height: 320px;
            }
        }
        
        /* Desktop - Better utilization */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
            }

            .nav {
                grid-template-columns: repeat(4, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ============================================
           ‚ú® APPLE MICRO-INTERACTIONS
           ============================================ */
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .nav-btn:hover,
        .page-btn:hover,
        .time-filter-btn:hover {
            transform: translateY(-1px);
        }

        /* Smooth transitions for all interactive elements */
        a, button, .btn, .card, .list-item, .nav-btn, .page-btn {
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Focus visible for accessibility */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">üì¶ Qu·∫£n L√Ω Xu·∫•t Nh·∫≠p H√†ng</div>
            <div class="header-subtitle">H·ªá th·ªëng qu·∫£n l√Ω kho h√†ng chuy√™n nghi·ªáp</div>
            
            <!-- Page Selector -->
            <div class="page-selector">
                <button class="page-btn active" data-page="RR88">RR88</button>
                <button class="page-btn" data-page="XX88">XX88</button>
                <button class="page-btn" data-page="MM88">MM88</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" data-section="dashboard">
                <span class="nav-btn-icon">üìä</span>
                <span class="nav-btn-text">T·ªïng Quan</span>
            </button>
            <button class="nav-btn" data-section="nhap">
                <span class="nav-btn-icon">üì•</span>
                <span class="nav-btn-text">Nh·∫≠p H√†ng</span>
            </button>
            <button class="nav-btn" data-section="xuat">
                <span class="nav-btn-icon">üì§</span>
                <span class="nav-btn-text">Xu·∫•t H√†ng</span>
            </button>
            <button class="nav-btn" data-section="tonkho">
                <span class="nav-btn-icon">üìã</span>
                <span class="nav-btn-text">T·ªìn Kho</span>
            </button>
            <button class="nav-btn" data-section="lichsu">
                <span class="nav-btn-icon">üïê</span>
                <span class="nav-btn-text">L·ªãch S·ª≠</span>
            </button>
            <button class="nav-btn" data-section="danhmuc">
                <span class="nav-btn-icon">‚öôÔ∏è</span>
                <span class="nav-btn-text">Danh M·ª•c</span>
            </button>
            <button class="nav-btn" data-section="khuvuc">
                <span class="nav-btn-icon">üìç</span>
                <span class="nav-btn-text">Khu V·ª±c</span>
            </button>
            <button class="nav-btn" data-section="bangthong">
                <span class="nav-btn-icon">üì°</span>
                <span class="nav-btn-text">BƒÉng Th√¥ng</span>
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <div class="section active" id="dashboard">
                <!-- BƒÉng Th√¥ng Hi·ªán T·∫°i -->
                <div class="card">
                    <div class="card-title">üì° BƒÉng Th√¥ng Hi·ªán T·∫°i</div>
                    <div id="dashboard-bandwidth-list"></div>
                </div>

                <!-- Time Filter & Summary (Combined) -->
                <div class="card">
                    <div class="card-title">üìä B·ªô L·ªçc & T·ªïng H·ª£p</div>
                    <div class="time-filter-buttons">
                        <button class="time-filter-btn" data-filter="day">
                            <span class="filter-icon">üìÖ</span>
                            <span class="filter-label">Ng√†y</span>
                            <span class="filter-sublabel">24h g·∫ßn nh·∫•t</span>
                        </button>
                        <button class="time-filter-btn active" data-filter="week">
                            <span class="filter-icon">üìÖ</span>
                            <span class="filter-label">Tu·∫ßn</span>
                            <span class="filter-sublabel">7 ng√†y g·∫ßn nh·∫•t</span>
                        </button>
                        <button class="time-filter-btn" data-filter="month">
                            <span class="filter-icon">üìÖ</span>
                            <span class="filter-label">Th√°ng</span>
                            <span class="filter-sublabel">Th√°ng hi·ªán t·∫°i</span>
                        </button>
                    </div>
                    <div class="time-range-display" id="time-range-display">
                        <span class="time-icon">üìä</span>
                        <span id="time-range-text">ƒêang t·∫£i...</span>
                    </div>
                    <div class="summary-grid" style="margin-top: 16px;">
                        <div class="summary-card success">
                            <div class="summary-icon">üì•</div>
                            <div class="summary-content">
                                <div class="summary-label">T·ªïng Nh·∫≠p</div>
                                <div class="summary-value" id="summary-nhap">0</div>
                                <div class="summary-trend" id="trend-nhap">
                                    <span class="trend-icon">‚Äï</span>
                                    <span class="trend-text">N/A</span>
                                </div>
                            </div>
                        </div>
                        <div class="summary-card danger">
                            <div class="summary-icon">üì§</div>
                            <div class="summary-content">
                                <div class="summary-label">T·ªïng Xu·∫•t</div>
                                <div class="summary-value" id="summary-xuat">0</div>
                                <div class="summary-trend" id="trend-xuat">
                                    <span class="trend-icon">‚Äï</span>
                                    <span class="trend-text">N/A</span>
                                </div>
                            </div>
                        </div>
                        <div class="summary-card info">
                            <div class="summary-icon">üì¶</div>
                            <div class="summary-content">
                                <div class="summary-label">Net</div>
                                <div class="summary-value" id="summary-net">0</div>
                                <div class="summary-trend" id="trend-net">
                                    <span class="trend-icon">‚Äï</span>
                                    <span class="trend-text">N/A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="card">
                    <div class="chart-header">
                        <div class="card-title">üìä Bi·ªÉu ƒê·ªì Xu·∫•t Nh·∫≠p</div>
                        <div class="chart-toggle">
                            <button class="chart-toggle-btn active" data-chart="bar">
                                <span>üìä</span>
                                <span>C·ªôt</span>
                            </button>
                            <button class="chart-toggle-btn" data-chart="pie">
                                <span>ü•ß</span>
                                <span>Tr√≤n</span>
                            </button>
                        </div>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="main-chart"></canvas>
                    </div>
                </div>

                <!-- Detail Table -->
                <div class="card">
                    <div class="card-title">üìã Chi Ti·∫øt Theo S·∫£n Ph·∫©m</div>
                    <div id="detail-table-container"></div>
                </div>
            </div>

            <!-- Nhap Hang Section -->
            <div class="section" id="nhap">
                <div class="card">
                    <div class="card-title">üì• Nh·∫≠p H√†ng M·ªõi</div>
                    <div style="text-align: right; margin-bottom: 12px;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="switchToBulkNhap()" style="width: auto; min-width: 140px;">
                            <span>üì¶</span>
                            <span>Nh·∫≠p Nhi·ªÅu</span>
                        </button>
                    </div>
                    <form id="form-nhap">
                        <div class="form-group">
                            <label class="form-label">S·∫£n Ph·∫©m</label>
                            <select class="form-control" id="nhap-product" required>
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë L∆∞·ª£ng</label>
                            <input type="number" class="form-control" id="nhap-quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi Ch√∫</label>
                            <input type="text" class="form-control" id="nhap-note" placeholder="Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)">
                        </div>
                        <button type="submit" class="btn btn-success">
                            <span>‚úÖ</span>
                            <span>Nh·∫≠p H√†ng</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Xuat Hang Section -->
            <div class="section" id="xuat">
                <div class="card">
                    <div class="card-title">üì§ Xu·∫•t H√†ng</div>
                    <div style="text-align: right; margin-bottom: 12px;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="switchToBulkXuat()" style="width: auto; min-width: 140px;">
                            <span>üìÆ</span>
                            <span>Xu·∫•t Nhi·ªÅu</span>
                        </button>
                    </div>
                    <form id="form-xuat">
                        <div class="form-group">
                            <label class="form-label">S·∫£n Ph·∫©m</label>
                            <select class="form-control" id="xuat-product" required>
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë L∆∞·ª£ng</label>
                            <input type="number" class="form-control" id="xuat-quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi Ch√∫</label>
                            <input type="text" class="form-control" id="xuat-note" placeholder="Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)">
                        </div>
                        <button type="submit" class="btn btn-danger">
                            <span>‚úÖ</span>
                            <span>Xu·∫•t H√†ng</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Nhap Hang Bulk Section -->
            <div class="section" id="nhap-bulk">
                <div class="card">
                    <div class="card-title">üì¶ Nh·∫≠p Nhi·ªÅu S·∫£n Ph·∫©m</div>
                    <div style="text-align: right; margin-bottom: 12px;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="switchToSingleNhap()" style="width: auto; min-width: 140px;">
                            <span>üì•</span>
                            <span>Nh·∫≠p L·∫ª</span>
                        </button>
                    </div>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Nh·∫≠p nhi·ªÅu s·∫£n ph·∫©m c√πng l√∫c. M·ªói s·∫£n ph·∫©m s·∫Ω t·∫°o m·ªôt giao d·ªãch ri√™ng.
                    </p>
                    <div id="bulk-nhap-list"></div>
                    <div class="bulk-add-row" onclick="addBulkNhapRow()">
                        <span>‚ûï Th√™m S·∫£n Ph·∫©m</span>
                    </div>
                    <div class="bulk-summary">
                        <span class="bulk-summary-label">T·ªïng s·∫£n ph·∫©m:</span>
                        <span class="bulk-summary-value" id="bulk-nhap-count">0</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ghi Ch√∫ Chung</label>
                        <input type="text" class="form-control" id="bulk-nhap-note" placeholder="Ghi ch√∫ chung (kh√¥ng b·∫Øt bu·ªôc)">
                    </div>
                    <button class="btn btn-success" onclick="handleBulkNhap()">
                        <span>‚úÖ</span>
                        <span>Nh·∫≠p T·∫•t C·∫£</span>
                    </button>
                </div>
            </div>

            <!-- Xuat Hang Bulk Section -->
            <div class="section" id="xuat-bulk">
                <div class="card">
                    <div class="card-title">üìÆ Xu·∫•t Nhi·ªÅu S·∫£n Ph·∫©m</div>
                    <div style="text-align: right; margin-bottom: 12px;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="switchToSingleXuat()" style="width: auto; min-width: 140px;">
                            <span>üì§</span>
                            <span>Xu·∫•t L·∫ª</span>
                        </button>
                    </div>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Xu·∫•t nhi·ªÅu s·∫£n ph·∫©m c√πng l√∫c. H·ªá th·ªëng s·∫Ω ki·ªÉm tra t·ªìn kho cho t·ª´ng s·∫£n ph·∫©m.
                    </p>
                    <div id="bulk-xuat-list"></div>
                    <div class="bulk-add-row" onclick="addBulkXuatRow()">
                        <span>‚ûï Th√™m S·∫£n Ph·∫©m</span>
                    </div>
                    <div class="bulk-summary">
                        <span class="bulk-summary-label">T·ªïng s·∫£n ph·∫©m:</span>
                        <span class="bulk-summary-value" id="bulk-xuat-count">0</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ghi Ch√∫ Chung</label>
                        <input type="text" class="form-control" id="bulk-xuat-note" placeholder="Ghi ch√∫ chung (kh√¥ng b·∫Øt bu·ªôc)">
                    </div>
                    <button class="btn btn-danger" onclick="handleBulkXuat()">
                        <span>‚úÖ</span>
                        <span>Xu·∫•t T·∫•t C·∫£</span>
                    </button>
                </div>
            </div>

            <!-- Ton Kho Section -->
            <div class="section" id="tonkho">
                <div class="card">
                    <div class="card-title">üìã T·ªìn Kho Hi·ªán T·∫°i</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="exportExcel()" style="flex: 1; min-width: 140px;">
                            <span>üìä</span>
                            <span>Xu·∫•t File Excel</span>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="syncToGoogleSheet()" style="flex: 1; min-width: 140px;">
                            <span>‚òÅÔ∏è</span>
                            <span>ƒê·ªìng B·ªô GSheet</span>
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-tonkho" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m...">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div id="tonkho-list"></div>
                </div>
            </div>

            <!-- Lich Su Section -->
            <div class="section" id="lichsu">
                <div class="card">
                    <div class="card-title">üïê L·ªãch S·ª≠ Xu·∫•t Nh·∫≠p</div>
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-lichsu" placeholder="T√¨m ki·∫øm...">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="filter-type">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="nhap">Nh·∫≠p v·ªÅ</option>
                            <option value="xuat">C·∫•p ph√°t</option>
                        </select>
                    </div>
                    <div id="lichsu-list"></div>
                </div>
            </div>

            <!-- Danh Muc Section -->
            <div class="section" id="danhmuc">
                <div class="card">
                    <div class="card-title">‚öôÔ∏è Qu·∫£n L√Ω Danh M·ª•c</div>
                    <button class="btn btn-primary" id="btn-add-product" style="margin-bottom: 16px;">
                        <span>‚ûï</span>
                        <span>Th√™m S·∫£n Ph·∫©m M·ªõi</span>
                    </button>
                    <div id="danhmuc-list"></div>
                </div>
            </div>

            <!-- Khu Vuc Section -->
            <div class="section" id="khuvuc">
                <div class="card">
                    <div class="card-title">üìç Qu·∫£n L√Ω Khu V·ª±c</div>
                    <button class="btn btn-primary" id="btn-add-location" style="margin-bottom: 16px;">
                        <span>‚ûï</span>
                        <span>Th√™m Khu V·ª±c M·ªõi</span>
                    </button>
                    <div id="khuvuc-list"></div>
                </div>
            </div>

            <!-- BƒÉng Th√¥ng Section -->
            <div class="section" id="bangthong">
                <!-- Form C·∫≠p Nh·∫≠t BƒÉng Th√¥ng -->
                <div class="card">
                    <div class="card-title">üì° C·∫≠p Nh·∫≠t BƒÉng Th√¥ng</div>
                    <form id="form-bangthong">
                        <div class="form-group">
                            <label class="form-label">Khu V·ª±c</label>
                            <select class="form-control" id="bt-location" required>
                                <option value="">-- Ch·ªçn khu v·ª±c --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lo·∫°i S·ª± Ki·ªán</label>
                            <select class="form-control" id="bt-event-type" required>
                                <option value="">-- Ch·ªçn lo·∫°i s·ª± ki·ªán --</option>
                                <option value="moi">üÜï L·∫Øp ƒê·∫∑t M·ªõi</option>
                                <option value="tang">üìà TƒÉng BƒÉng Th√¥ng</option>
                                <option value="giam">üìâ Gi·∫£m BƒÉng Th√¥ng</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">BƒÉng Th√¥ng Hi·ªán T·∫°i (Mbps)</label>
                            <input type="number" class="form-control" id="bt-current" value="0" min="0" step="0.1" readonly style="background: var(--bg-tertiary); opacity: 0.7;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gi√° Tr·ªã Thay ƒê·ªïi (Mbps)</label>
                            <input type="number" class="form-control" id="bt-change" placeholder="VD: 100" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">BƒÉng Th√¥ng Sau Thay ƒê·ªïi (Mbps)</label>
                            <input type="number" class="form-control" id="bt-after" value="0" min="0" step="0.1" readonly style="background: var(--bg-tertiary); font-weight: 600; font-size: 16px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi Ch√∫</label>
                            <textarea class="form-control" id="bt-note" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·ª± ki·ªán..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ</span>
                            <span>L∆∞u C·∫≠p Nh·∫≠t</span>
                        </button>
                    </form>
                </div>

                <!-- BƒÉng Th√¥ng Hi·ªán T·∫°i -->
                <div class="card">
                    <div class="card-title">üìä BƒÉng Th√¥ng Hi·ªán T·∫°i C√°c Khu</div>
                    <div id="current-bandwidth-list"></div>
                </div>

                <!-- L·ªãch S·ª≠ BƒÉng Th√¥ng -->
                <div class="card">
                    <div class="card-title">üïê L·ªãch S·ª≠ Thay ƒê·ªïi</div>
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="search-bandwidth" placeholder="T√¨m ki·∫øm theo khu v·ª±c...">
                    </div>
                    <div id="bandwidth-history-list"></div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>ƒêang x·ª≠ l√Ω...</div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast">
            <div class="toast-icon" id="toast-icon"></div>
            <div class="toast-message" id="toast-message"></div>
        </div>

        <!-- Add/Edit Product Modal -->
        <div class="modal" id="modal-product">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-product-title">Th√™m S·∫£n Ph·∫©m</div>
                    <button class="modal-close" onclick="closeModal('modal-product')">√ó</button>
                </div>
                <form id="form-product">
                    <input type="hidden" id="product-id">
                    <div class="form-group">
                        <label class="form-label">T√™n S·∫£n Ph·∫©m</label>
                        <input type="text" class="form-control" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ƒê∆°n V·ªã</label>
                        <input type="text" class="form-control" id="product-unit" placeholder="VD: Th√πng, C√°i, Kg..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√¥ T·∫£</label>
                        <input type="text" class="form-control" id="product-description" placeholder="M√¥ t·∫£ (kh√¥ng b·∫Øt bu·ªôc)">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>üíæ</span>
                        <span>L∆∞u S·∫£n Ph·∫©m</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Add/Edit Location Modal -->
        <div class="modal" id="modal-location">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-location-title">Th√™m Khu V·ª±c</div>
                    <button class="modal-close" onclick="closeModal('modal-location')">√ó</button>
                </div>
                <form id="form-location">
                    <input type="hidden" id="location-id">
                    <div class="form-group">
                        <label class="form-label">T√™n Khu V·ª±c</label>
                        <input type="text" class="form-control" id="location-name" placeholder="VD: VƒÉn ph√≤ng t·∫ßng 8" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√¥ T·∫£</label>
                        <input type="text" class="form-control" id="location-description" placeholder="M√¥ t·∫£ chi ti·∫øt khu v·ª±c (kh√¥ng b·∫Øt bu·ªôc)">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>üíæ</span>
                        <span>L∆∞u Khu V·ª±c</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Google Sheet Sync Modal -->
        <div class="modal" id="modal-gsheet-sync">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">‚òÅÔ∏è ƒê·ªìng B·ªô Google Sheets</div>
                    <button class="modal-close" onclick="closeModal('modal-gsheet-sync')">√ó</button>
                </div>
                
                <!-- Sync Progress -->
                <div id="sync-progress" class="sync-progress">
                    <div class="sync-status">
                        <div class="sync-icon" id="sync-icon">‚òÅÔ∏è</div>
                        <div class="sync-message" id="sync-message">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</div>
                    </div>
                    <div class="sync-spinner" id="sync-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <!-- Sync Result -->
                <div id="sync-result" class="sync-result" style="display: none;">
                    <div class="sync-success-icon">‚úÖ</div>
                    <h3 style="margin: 16px 0 8px 0; color: var(--success);">ƒê·ªìng B·ªô Th√†nh C√¥ng!</h3>
                    <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                        D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô l√™n Google Sheets
                    </p>
                    
                    <div class="gsheet-info">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                            üìä Sheets ƒë√£ t·∫°o:
                        </div>
                        <div style="font-size: 12px; color: var(--text-primary); line-height: 1.6;">
                            ‚Ä¢ RR88 - T·ªìn Kho<br>
                            ‚Ä¢ XX88 - T·ªìn Kho<br>
                            ‚Ä¢ MM88 - T·ªìn Kho<br>
                            ‚Ä¢ L·ªãch S·ª≠ Xu·∫•t Nh·∫≠p (All)
                        </div>
                    </div>
                    
                    <div class="gsheet-link">
                        <input type="text" class="form-control" id="gsheet-url" readonly style="font-size: 12px; margin-bottom: 12px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="copyGSheetLink()" style="flex: 1;">
                                <span>üìã</span>
                                <span>Copy Link</span>
                            </button>
                            <button class="btn btn-primary" onclick="openGSheet()" style="flex: 1;">
                                <span>üîó</span>
                                <span>M·ªü Google Sheet</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sync Error -->
                <div id="sync-error" class="sync-error" style="display: none;">
                    <div class="sync-error-icon">‚ùå</div>
                    <h3 style="margin: 16px 0 8px 0; color: var(--danger);">ƒê·ªìng B·ªô Th·∫•t B·∫°i</h3>
                    <p id="sync-error-message" style="color: var(--text-secondary); font-size: 14px;"></p>
                    <button class="btn btn-secondary" onclick="closeModal('modal-gsheet-sync')" style="margin-top: 20px;">
                        <span>ƒê√≥ng</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                showLoading();
                
                // Step 1: Check permissions first
                const authResult = await checkUserPermissions();
                
                if (!authResult.authorized) {
                    handleUnauthorized(authResult.message);
                    hideLoading();
                    return;
                }
                
                // Step 2: Setup allowed pages
                allowedPages = authResult.pages || [];
                
                // Step 3: Set default page to first allowed page
                if (allowedPages.length > 0) {
                    currentPage = allowedPages[0];
                }
                
                // Step 4: Update UI to show only allowed pages
                updatePageButtons();
                
                // Step 5: Load data for allowed page
                await loadProducts();
                await loadTransactions();
                await loadInventory();
                await loadLocations();
                await loadBandwidthLogs();

                // Step 6: Setup listeners
                setupEventListeners();
                updateDashboard();
                
                hideLoading();
                showToast('success', '·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng! üéâ');
            } catch (error) {
                hideLoading();
                if (error.message !== 'Unauthorized') {
                    showToast('error', 'L·ªói kh·ªüi t·∫°o: ' + error.message);
                    logError('Initialize Error', error);
                }
            }
        }
        
        async function checkUserPermissions() {
            try {
                const url = `${CONFIG.N8N_WEBHOOK_URL}/${CONFIG.API_PATH}?endpoint=check_auth&user_id=${currentUserId}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    return { authorized: false, message: 'Kh√¥ng th·ªÉ ki·ªÉm tra quy·ªÅn' };
                }
                
                const result = await response.json();
                
                if (result.success && result.authorized) {
                    // Parse pages string to array
                    const pagesStr = result.pages || '';
                    const pages = pagesStr.split(',').map(p => p.trim()).filter(p => p);
                    
                    return {
                        authorized: true,
                        pages: pages
                    };
                }
                
                return {
                    authorized: false,
                    message: result.message || 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p'
                };
            } catch (error) {
                console.error('[Auth] Check permission error:', error);
                return {
                    authorized: false,
                    message: 'L·ªói ki·ªÉm tra quy·ªÅn'
                };
            }
        }
        
        function updatePageButtons() {
            const allPages = ['RR88', 'XX88', 'MM88'];
            
            allPages.forEach(page => {
                const btn = document.querySelector(`.page-btn[data-page="${page}"]`);
                if (btn) {
                    if (allowedPages.includes(page)) {
                        // User c√≥ quy·ªÅn - show button
                        btn.style.display = '';
                        // Set active cho page ƒë·∫ßu ti√™n
                        if (page === currentPage) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    } else {
                        // User kh√¥ng c√≥ quy·ªÅn - hide button
                        btn.style.display = 'none';
                    }
                }
            });
        }

        function setupEventListeners() {
            // Dashboard filters
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTimeFilter = this.dataset.filter;
                    updateDashboard();
                });
            });
            
            document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentChartType = this.dataset.chart;
                    updateChart();
                });
            });
            
            // Page selector
            document.querySelectorAll('.page-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    document.querySelectorAll('.page-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPage = this.dataset.page;
                    try {
                        showLoading();
                        await loadProducts();
                        await loadTransactions();
                        await loadInventory();
                        await loadLocations();
                        await loadBandwidthLogs();
                        refreshCurrentSection();
                        hideLoading();
                    } catch (error) {
                        hideLoading();
                        showToast('error', 'L·ªói khi chuy·ªÉn page: ' + error.message);
                    }
                });
            });

            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    showSection(this.dataset.section);
                });
            });

            // Forms - v·ªõi null check
            const formNhap = document.getElementById('form-nhap');
            if (formNhap) {
                formNhap.addEventListener('submit', handleNhapHang);
            }
            
            const formXuat = document.getElementById('form-xuat');
            if (formXuat) {
                formXuat.addEventListener('submit', handleXuatHang);
            }
            
            const formProduct = document.getElementById('form-product');
            if (formProduct) {
                formProduct.addEventListener('submit', handleSaveProduct);
            }

            const formLocation = document.getElementById('form-location');
            if (formLocation) {
                formLocation.addEventListener('submit', handleSaveLocation);
            }

            const formBangThong = document.getElementById('form-bangthong');
            if (formBangThong) {
                formBangThong.addEventListener('submit', handleBandwidthSubmit);
            }

            // Search - v·ªõi null check
            const searchTonKho = document.getElementById('search-tonkho');
            if (searchTonKho) {
                searchTonKho.addEventListener('input', debounce(filterTonKho, 300));
            }

            const searchLichSu = document.getElementById('search-lichsu');
            if (searchLichSu) {
                searchLichSu.addEventListener('input', debounce(filterLichSu, 300));
            }

            const searchBandwidth = document.getElementById('search-bandwidth');
            if (searchBandwidth) {
                searchBandwidth.addEventListener('input', debounce(filterBandwidth, 300));
            }

            const filterType = document.getElementById('filter-type');
            if (filterType) {
                filterType.addEventListener('change', filterLichSu);
            }

            // Buttons
            const btnAddProduct = document.getElementById('btn-add-product');
            if (btnAddProduct) {
                btnAddProduct.addEventListener('click', () => openProductModal());
            }

            const btnAddLocation = document.getElementById('btn-add-location');
            if (btnAddLocation) {
                btnAddLocation.addEventListener('click', () => openLocationModal());
            }

            // Bandwidth auto-calculation
            const btLocation = document.getElementById('bt-location');
            if (btLocation) {
                btLocation.addEventListener('change', updateCurrentBandwidth);
            }

            const btChange = document.getElementById('bt-change');
            if (btChange) {
                btChange.addEventListener('input', calculateBandwidthAfter);
            }

            const btEventType = document.getElementById('bt-event-type');
            if (btEventType) {
                btEventType.addEventListener('change', calculateBandwidthAfter);
            }

            // Setup modal listeners
            setupModalListeners();
        }

        function showSection(sectionId) {
            currentSection = sectionId;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId)?.classList.add('active');
            
            // Refresh section data
            refreshCurrentSection();
        }

        function refreshCurrentSection() {
            switch(currentSection) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'nhap':
                    updateProductSelects();
                    break;
                case 'nhap-bulk':
                    renderBulkNhapList();
                    break;
                case 'xuat':
                    updateProductSelects();
                    break;
                case 'xuat-bulk':
                    renderBulkXuatList();
                    break;
                case 'tonkho':
                    displayTonKho();
                    break;
                case 'lichsu':
                    displayLichSu();
                    break;
                case 'danhmuc':
                    displayDanhMuc();
                    break;
                case 'khuvuc':
                    displayKhuVuc();
                    break;
                case 'bangthong':
                    displayBandwidth();
                    updateLocationDropdown();
                    // Trigger update sau khi dropdown ƒë√£ c√≥ data
                    setTimeout(() => updateCurrentBandwidth(), 100);
                    break;
            }
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (data) {
                    options.body = JSON.stringify({
                        ...data,
                        page: currentPage,
                        user: currentUser,
                        timestamp: new Date().toISOString(),
                    });
                }

                // Include user_id in URL for authentication
                const url = `${CONFIG.N8N_WEBHOOK_URL}/${CONFIG.API_PATH}?endpoint=${endpoint}&page=${currentPage}&user_id=${currentUserId}`;
                console.log('[API] Calling:', method, url);
                
                const response = await fetch(url, options);
                
                console.log('[API] Response status:', response.status);
                console.log('[API] Response OK:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[API] Error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Get response text first
                const responseText = await response.text();
                console.log('[API] Response text:', responseText);
                
                // Try parse JSON
                if (!responseText || responseText.trim() === '') {
                    throw new Error('Empty response from server');
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('[API] Parsed result:', result);
                } catch (parseError) {
                    console.error('[API] JSON parse error:', parseError);
                    console.error('[API] Invalid JSON:', responseText);
                    throw new Error('Invalid JSON response from server');
                }
                
                // Check for unauthorized
                if (result.success === false && result.error === 'Unauthorized') {
                    handleUnauthorized(result.message);
                    throw new Error('Unauthorized');
                }
                
                return result;
            } catch (error) {
                console.error('[API] Error:', error);
                logError('API Call Error', error);
                throw error;
            }
        }
        
        function handleUnauthorized(message) {
            // Hide loading
            hideLoading();
            
            // Show unauthorized message
            const content = document.querySelector('.content');
            if (content) {
                content.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                        <h2 style="margin-bottom: 16px;">Kh√¥ng C√≥ Quy·ªÅn Truy C·∫≠p</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">
                            ${message || 'B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠ d·ª•ng ·ª©ng d·ª•ng n√†y.'}
                        </p>
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">
                            Telegram ID c·ªßa b·∫°n:<br>
                            <strong style="font-size: 18px; color: var(--primary);">${currentUserId || 'N/A'}</strong>
                        </p>
                        <a href="https://t.me/PinusITRR88" class="btn btn-primary" style="text-decoration: none; max-width: 300px; margin: 0 auto; display: inline-flex;">
                            <span>üí¨</span>
                            <span>Li√™n H·ªá Admin ƒê·ªÉ ƒê∆∞·ª£c C·∫•p Quy·ªÅn</span>
                        </a>
                        <p style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                            G·ª≠i Telegram ID c·ªßa b·∫°n cho Admin @PinusITRR88
                        </p>
                    </div>
                `;
            }
            
            // Disable navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            document.querySelectorAll('.page-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        }


        // Data Loading Functions
        async function loadProducts() {
            try {
                const response = await apiCall('products', 'GET');
                if (response.success) {
                    products = response.data || [];
                }
            } catch (error) {
                // If unauthorized, don't show error toast
                if (error.message !== 'Unauthorized') {
                    logError('Load Products Error', error);
                    showToast('error', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m');
                }
                throw error; // Stop initialization
            }
        }

        async function loadTransactions() {
            try {
                const response = await apiCall('transactions', 'GET');
                if (response.success) {
                    transactions = response.data || [];
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    logError('Load Transactions Error', error);
                    showToast('error', 'Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ xu·∫•t nh·∫≠p');
                }
                // Don't throw, continue loading
            }
        }

        async function loadInventory() {
            try {
                const response = await apiCall('inventory', 'GET');
                if (response.success) {
                    if (!inventory[currentPage]) {
                        inventory[currentPage] = {};
                    }
                    const data = response.data || [];
                    data.forEach(item => {
                        inventory[currentPage][item.product_id] = item.quantity;
                    });
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    logError('Load Inventory Error', error);
                    showToast('error', 'Kh√¥ng th·ªÉ t·∫£i t·ªìn kho');
                }
                // Don't throw, continue
            }
        }

        async function loadLocations() {
            try {
                const response = await apiCall('locations', 'GET');
                if (response.success) {
                    locations = response.data || [];
                    updateLocationDropdown();
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    logError('Load Locations Error', error);
                    showToast('error', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch khu v·ª±c');
                }
                // Don't throw, continue
            }
        }

        function updateLocationDropdown() {
            const dropdown = document.getElementById('bt-location');
            if (!dropdown) return;

            const pageLocations = locations.filter(loc => loc.page === currentPage);
            const currentValue = dropdown.value; // L∆∞u gi√° tr·ªã ƒëang ch·ªçn

            dropdown.innerHTML = '<option value="">-- Ch·ªçn khu v·ª±c --</option>';
            pageLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.name;
                option.textContent = loc.name;
                dropdown.appendChild(option);
            });

            // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn (n·∫øu c√≥)
            if (currentValue && pageLocations.some(loc => loc.name === currentValue)) {
                dropdown.value = currentValue;
            }

            // Trigger update bandwidth sau khi dropdown ready
            updateCurrentBandwidth();
        }

        function updateCurrentBandwidth() {
            const locationSelect = document.getElementById('bt-location');
            const currentInput = document.getElementById('bt-current');

            if (!locationSelect || !currentInput) {
                return;
            }

            const selectedLocation = locationSelect.value;
            if (!selectedLocation) {
                currentInput.value = 0;
                calculateBandwidthAfter();
                return;
            }

            // Get current bandwidth from currentBandwidth object
            const locationData = currentBandwidth[selectedLocation];
            const currentBW = locationData ? locationData.bandwidth : 0;

            currentInput.value = currentBW;

            // Trigger calculation
            calculateBandwidthAfter();
        }

        function calculateBandwidthAfter() {
            const currentInput = document.getElementById('bt-current');
            const changeInput = document.getElementById('bt-change');
            const afterInput = document.getElementById('bt-after');
            const eventTypeSelect = document.getElementById('bt-event-type');

            if (!currentInput || !changeInput || !afterInput || !eventTypeSelect) return;

            const current = parseFloat(currentInput.value) || 0;
            const changeValue = parseFloat(changeInput.value) || 0;
            const eventType = eventTypeSelect.value;

            // T·ª± ƒë·ªông th√™m d·∫•u +/- d·ª±a v√†o event type
            let actualChange = 0;
            if (eventType === 'moi') {
                // L·∫Øp m·ªõi: gi√° tr·ªã nh·∫≠p = bƒÉng th√¥ng m·ªõi
                actualChange = Math.abs(changeValue);
            } else if (eventType === 'tang') {
                // TƒÉng: lu√¥n l√† d∆∞∆°ng
                actualChange = Math.abs(changeValue);
            } else if (eventType === 'giam') {
                // Gi·∫£m: lu√¥n l√† √¢m
                actualChange = -Math.abs(changeValue);
            }

            // T√≠nh bƒÉng th√¥ng sau
            let result = 0;
            if (eventType === 'moi') {
                // L·∫Øp m·ªõi: bƒÉng th√¥ng sau = gi√° tr·ªã m·ªõi
                result = actualChange;
            } else {
                // TƒÉng/Gi·∫£m: bƒÉng th√¥ng sau = hi·ªán t·∫°i + thay ƒë·ªïi
                result = current + actualChange;
            }

            afterInput.value = Math.max(0, result); // Kh√¥ng cho √¢m
        }

        // Form Handlers
        async function handleNhapHang(e) {
            e.preventDefault();
            
            const productId = document.getElementById('nhap-product').value;
            const quantity = document.getElementById('nhap-quantity').value;
            const note = document.getElementById('nhap-note').value;

            if (!productId || !quantity) {
                showToast('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                showLoading();
                
                const response = await apiCall('transactions', 'POST', {
                    type: 'nhap',
                    product_id: parseInt(productId),
                    quantity: parseInt(quantity),
                    note: note,
                });

                if (response.success) {
                    showToast('success', '‚úÖ Nh·∫≠p h√†ng th√†nh c√¥ng!');
                    e.target.reset();
                    await loadTransactions();
                    await loadInventory();
                    updateDashboard();
                } else {
                    throw new Error(response.message || 'L·ªói nh·∫≠p h√†ng');
                }
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Nhap Hang Error', error);
            } finally {
                hideLoading();
            }
        }

        async function handleXuatHang(e) {
            e.preventDefault();
            
            const productId = document.getElementById('xuat-product').value;
            const quantity = document.getElementById('xuat-quantity').value;
            const note = document.getElementById('xuat-note').value;

            if (!productId || !quantity) {
                showToast('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            // Check inventory
            const currentInventory = inventory[currentPage]?.[productId] || 0;
            if (currentInventory < parseInt(quantity)) {
                showToast('error', `Kh√¥ng ƒë·ªß h√†ng! T·ªìn kho: ${currentInventory}`);
                return;
            }

            try {
                showLoading();
                
                const response = await apiCall('transactions', 'POST', {
                    type: 'xuat',
                    product_id: parseInt(productId),
                    quantity: parseInt(quantity),
                    note: note,
                });

                if (response.success) {
                    showToast('success', '‚úÖ Xu·∫•t h√†ng th√†nh c√¥ng!');
                    e.target.reset();
                    await loadTransactions();
                    await loadInventory();
                    updateDashboard();
                } else {
                    throw new Error(response.message || 'L·ªói xu·∫•t h√†ng');
                }
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Xuat Hang Error', error);
            } finally {
                hideLoading();
            }
        }

        async function handleSaveProduct(e) {
            e.preventDefault();

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const unit = document.getElementById('product-unit').value;
            const description = document.getElementById('product-description').value;

            try {
                showLoading();

                const response = await apiCall('products', 'POST', {
                    id: id && id.trim() !== '' ? parseInt(id) : null, // Only send ID if exists
                    name: name,
                    unit: unit,
                    description: description,
                    page: currentPage,
                });

                if (response.success) {
                    showToast('success', id ? '‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!' : '‚úÖ Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!');
                    closeModal('modal-product');
                    await loadProducts();
                    displayDanhMuc();
                    updateProductSelects();
                } else {
                    throw new Error(response.message || 'L·ªói l∆∞u s·∫£n ph·∫©m');
                }
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Save Product Error', error);
            } finally {
                hideLoading();
            }
        }

        // Location CRUD Functions
        function openLocationModal(locationId = null) {
            const modal = document.getElementById('modal-location');
            const title = document.getElementById('modal-location-title');
            const form = document.getElementById('form-location');

            form.reset();
            document.getElementById('location-id').value = '';

            if (locationId) {
                const location = locations.find(loc => loc.id === locationId);
                if (location) {
                    title.textContent = 'S·ª≠a Khu V·ª±c';
                    document.getElementById('location-id').value = location.id;
                    document.getElementById('location-name').value = location.name;
                    document.getElementById('location-description').value = location.description || '';
                }
            } else {
                title.textContent = 'Th√™m Khu V·ª±c';
                document.getElementById('location-id').value = '';
            }

            modal.classList.add('active');
        }

        function editLocation(locationId) {
            openLocationModal(locationId);
        }

        async function deleteLocation(locationId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a khu v·ª±c n√†y?')) {
                return;
            }

            try {
                showLoading();
                const response = await apiCall('locations', 'POST', {
                    action: 'delete',
                    id: locationId
                });

                if (response.success) {
                    showToast('success', '‚úÖ X√≥a khu v·ª±c th√†nh c√¥ng!');
                    await loadLocations();
                    displayKhuVuc();
                } else {
                    throw new Error(response.message || 'L·ªói x√≥a khu v·ª±c');
                }
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Delete Location Error', error);
            } finally {
                hideLoading();
            }
        }

        async function handleSaveLocation(e) {
            e.preventDefault();

            const id = document.getElementById('location-id').value;
            const name = document.getElementById('location-name').value;
            const description = document.getElementById('location-description').value;

            try {
                showLoading();

                const response = await apiCall('locations', 'POST', {
                    id: id && id.trim() !== '' ? parseInt(id) : null,
                    name: name,
                    description: description,
                    page: currentPage,
                });

                if (response.success) {
                    showToast('success', id ? '‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!' : '‚úÖ Th√™m khu v·ª±c th√†nh c√¥ng!');
                    closeModal('modal-location');
                    await loadLocations();
                    displayKhuVuc();
                } else {
                    throw new Error(response.message || 'L·ªói l∆∞u khu v·ª±c');
                }
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Save Location Error', error);
            } finally {
                hideLoading();
            }
        }

        // ===== DASHBOARD NEW FUNCTIONS =====
        
        // Time Range Functions
        function getTimeRange(filter) {
            const end = new Date();
            let start;
            
            switch(filter) {
                case 'day':
                    start = new Date(end - 24 * 60 * 60 * 1000);
                    break;
                case 'week':
                    start = new Date(end - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    start = new Date(end.getFullYear(), end.getMonth(), 1);
                    break;
                default:
                    start = new Date(end - 7 * 24 * 60 * 60 * 1000);
            }
            
            return { start, end };
        }
        
        function formatDateRange(start, end) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const startStr = start.toLocaleDateString('vi-VN', options);
            const endStr = end.toLocaleDateString('vi-VN', options);
            return `${startStr} ‚Üí ${endStr}`;
        }
        
        // Filter transactions by time range
        function filterTransactionsByTime(trans, start, end) {
            return trans.filter(t => {
                const tDate = new Date(t.timestamp);
                return tDate >= start && tDate <= end;
            });
        }
        
        // Aggregate data by product
        function aggregateByProduct(trans, pageProducts) {
            const aggregated = [];
            
            pageProducts.forEach(product => {
                const productTrans = trans.filter(t => t.product_id === product.id);
                
                const nhap = productTrans
                    .filter(t => t.type === 'nhap')
                    .reduce((sum, t) => sum + parseInt(t.quantity), 0);
                    
                const xuat = productTrans
                    .filter(t => t.type === 'xuat')
                    .reduce((sum, t) => sum + parseInt(t.quantity), 0);
                
                aggregated.push({
                    id: product.id,
                    name: product.name,
                    unit: product.unit,
                    nhap: nhap,
                    xuat: xuat,
                    net: nhap - xuat
                });
            });
            
            return aggregated;
        }
        
        // Calculate trend compared to previous period
        function calculateTrend(current, previous) {
            if (previous === 0) {
                return current > 0 ? 100 : 0;
            }
            return ((current - previous) / previous * 100).toFixed(1);
        }
        
        // Get previous period transactions
        function getPreviousPeriodData(filter) {
            const { start, end } = getTimeRange(filter);
            const duration = end - start;
            
            const prevEnd = new Date(start.getTime() - 1);
            const prevStart = new Date(prevEnd - duration);
            
            const pageTrans = transactions.filter(t => t.page === currentPage);
            return filterTransactionsByTime(pageTrans, prevStart, prevEnd);
        }
        
        // Main Dashboard Update Function
        function updateDashboard() {
            try {
                const { start, end } = getTimeRange(currentTimeFilter);
                const pageTrans = transactions.filter(t => t.page === currentPage);
                const pageProducts = products.filter(p => p.page === currentPage);
                
                // Filter transactions by time
                const filteredTrans = filterTransactionsByTime(pageTrans, start, end);
                const previousTrans = getPreviousPeriodData(currentTimeFilter);
                
                // Aggregate data
                const productData = aggregateByProduct(filteredTrans, pageProducts);
                
                // Calculate totals
                const totalNhap = productData.reduce((sum, p) => sum + p.nhap, 0);
                const totalXuat = productData.reduce((sum, p) => sum + p.xuat, 0);
                const totalNet = totalNhap - totalXuat;
                
                // Calculate previous totals for trend
                const prevProductData = aggregateByProduct(previousTrans, pageProducts);
                const prevNhap = prevProductData.reduce((sum, p) => sum + p.nhap, 0);
                const prevXuat = prevProductData.reduce((sum, p) => sum + p.xuat, 0);
                const prevNet = prevNhap - prevXuat;
                
                // Store for chart use
                dashboardData = {
                    products: productData,
                    summary: {
                        nhap: totalNhap,
                        xuat: totalXuat,
                        net: totalNet,
                        trendNhap: calculateTrend(totalNhap, prevNhap),
                        trendXuat: calculateTrend(totalXuat, prevXuat),
                        trendNet: calculateTrend(totalNet, prevNet)
                    }
                };
                
                // Update UI
                updateTimeRangeDisplay(start, end);
                updateSummaryCards(dashboardData.summary);
                updateDashboardBandwidth();
                updateChart();
                updateDetailTable(productData);

            } catch (error) {
                console.error('Update Dashboard Error:', error);
                logError('Update Dashboard', error);
            }
        }

        function updateDashboardBandwidth() {
            const container = document.getElementById('dashboard-bandwidth-list');
            if (!container) return;

            const locations = Object.values(currentBandwidth);

            if (locations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì°</div><div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu bƒÉng th√¥ng</div></div>';
                return;
            }

            // Sort by bandwidth (highest first)
            locations.sort((a, b) => b.bandwidth - a.bandwidth);

            container.innerHTML = locations.map(loc => {
                const updateDate = loc.lastUpdate ? new Date(loc.lastUpdate).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '';
                return `
                    <div class="list-item" style="margin-bottom: 8px; padding: 8px 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">${loc.location}</div>
                                ${updateDate ? `<div style="font-size: 10px; color: var(--text-tertiary);">C·∫≠p nh·∫≠t: ${updateDate}</div>` : ''}
                            </div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--primary);">
                                ${loc.bandwidth}<span style="font-size: 10px; font-weight: 500; opacity: 0.7; margin-left: 2px;">Mbps</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update time range display
        function updateTimeRangeDisplay(start, end) {
            const el = document.getElementById('time-range-text');
            if (el) {
                el.textContent = formatDateRange(start, end);
            }
        }
        
        // Update summary cards with trends
        function updateSummaryCards(summary) {
            // Nh·∫≠p
            const nhapValue = document.getElementById('summary-nhap');
            const nhapTrend = document.getElementById('trend-nhap');
            if (nhapValue) nhapValue.textContent = summary.nhap;
            if (nhapTrend) {
                updateTrendElement(nhapTrend, summary.trendNhap);
            }
            
            // Xu·∫•t
            const xuatValue = document.getElementById('summary-xuat');
            const xuatTrend = document.getElementById('trend-xuat');
            if (xuatValue) xuatValue.textContent = summary.xuat;
            if (xuatTrend) {
                updateTrendElement(xuatTrend, summary.trendXuat);
            }
            
            // Net
            const netValue = document.getElementById('summary-net');
            const netTrend = document.getElementById('trend-net');
            if (netValue) netValue.textContent = summary.net > 0 ? `+${summary.net}` : summary.net;
            if (netTrend) {
                updateTrendElement(netTrend, summary.trendNet);
            }
        }
        
        // Update trend element
        function updateTrendElement(el, trendValue) {
            const iconEl = el.querySelector('.trend-icon');
            const textEl = el.querySelector('.trend-text');
            
            if (trendValue === null || trendValue === 0) {
                el.className = 'summary-trend neutral';
                if (iconEl) iconEl.textContent = '‚Äï';
                if (textEl) textEl.textContent = 'N/A';
            } else if (trendValue > 0) {
                el.className = 'summary-trend up';
                if (iconEl) iconEl.textContent = '‚Üë';
                if (textEl) textEl.textContent = `${Math.abs(trendValue)}%`;
            } else {
                el.className = 'summary-trend down';
                if (iconEl) iconEl.textContent = '‚Üì';
                if (textEl) textEl.textContent = `${Math.abs(trendValue)}%`;
            }
        }
        
        // Update chart based on current type
        function updateChart() {
            if (!dashboardData || !dashboardData.products) return;
            
            if (currentChartType === 'bar') {
                renderBarChart(dashboardData.products);
            } else {
                renderPieChart(dashboardData.products);
            }
        }
        
        // Render Bar Chart
        function renderBarChart(productData) {
            const canvas = document.getElementById('main-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Limit to top 10 products by total activity (nhap + xuat)
            const topProducts = productData
                .map(p => ({...p, total: Math.abs(p.nhap) + Math.abs(p.xuat)}))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);

            // Prepare data
            const labels = topProducts.map(p => p.name);
            const nhapData = topProducts.map(p => p.nhap);
            const xuatData = topProducts.map(p => p.xuat);
            
            // Get theme colors
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#EBEBF5' : '#000000';
            const gridColor = isDark ? '#2C2C2E' : '#F2F2F7';
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'üì• Nh·∫≠p',
                            data: nhapData,
                            backgroundColor: 'rgba(52, 199, 89, 0.8)',
                            borderColor: 'rgba(52, 199, 89, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                        },
                        {
                            label: 'üì§ Xu·∫•t',
                            data: xuatData,
                            backgroundColor: 'rgba(255, 59, 48, 0.8)',
                            borderColor: 'rgba(255, 59, 48, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 13 },
                                color: textColor
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                font: { size: 12 }
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor,
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Render Pie Chart
        function renderPieChart(productData) {
            const canvas = document.getElementById('main-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Limit to top 10 products by total activity
            const topProducts = productData
                .map(p => ({...p, total: Math.abs(p.nhap) + Math.abs(p.xuat)}))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);

            // Prepare data - combine nhap and xuat for all products
            const labels = [];
            const data = [];
            const backgrounds = [];

            topProducts.forEach((p, index) => {
                if (p.nhap > 0) {
                    labels.push(`${p.name} (Nh·∫≠p)`);
                    data.push(p.nhap);
                    backgrounds.push(`rgba(52, 199, 89, ${0.9 - index * 0.05})`);
                }
                if (p.xuat > 0) {
                    labels.push(`${p.name} (Xu·∫•t)`);
                    data.push(p.xuat);
                    backgrounds.push(`rgba(255, 59, 48, ${0.9 - index * 0.05})`);
                }
            });
            
            // Get theme
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#EBEBF5' : '#000000';
            
            chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgrounds,
                        borderWidth: 2,
                        borderColor: isDark ? '#1C1C1E' : '#FFFFFF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: { size: 12 },
                                color: textColor
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Update detail table
        function updateDetailTable(productData) {
            const container = document.getElementById('detail-table-container');
            if (!container) return;
            
            if (productData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y</div></div>';
                return;
            }
            
            // Sort by net (highest first)
            const sorted = [...productData].sort((a, b) => Math.abs(b.net) - Math.abs(a.net));
            
            container.innerHTML = `
                <div class="table-wrapper">
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>S·∫£n Ph·∫©m</th>
                                <th style="text-align: center;">üì• Nh·∫≠p</th>
                                <th style="text-align: center;">üì§ Xu·∫•t</th>
                                <th style="text-align: center;">üì¶ Net</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(item => `
                                <tr>
                                    <td class="product-name">${item.name}</td>
                                    <td class="quantity-nhap" style="text-align: center;">${item.nhap}</td>
                                    <td class="quantity-xuat" style="text-align: center;">${item.xuat}</td>
                                    <td class="quantity-net ${item.net > 0 ? 'positive' : item.net < 0 ? 'negative' : ''}" style="text-align: center;">
                                        ${item.net > 0 ? '+' : ''}${item.net}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateProductSelects() {
            const pageProducts = products.filter(p => p.page === currentPage);
            const pageInventory = inventory[currentPage] || {};
            const nhapSelect = document.getElementById('nhap-product');
            const xuatSelect = document.getElementById('xuat-product');

            const options = pageProducts.map(p => {
                const qty = pageInventory[p.id] || 0;
                const stockText = qty > 0 ? `c√≤n: ${qty}` : 'h·∫øt h√†ng';
                return `<option value="${p.id}">${p.name} (${stockText})</option>`;
            }).join('');
            
            if (nhapSelect) nhapSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>' + options;
            if (xuatSelect) xuatSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>' + options;
        }

        function displayTonKho() {
            const container = document.getElementById('tonkho-list');
            const pageProducts = products.filter(p => p.page === currentPage);
            const pageInventory = inventory[currentPage] || {};

            if (pageProducts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</div></div>';
                return;
            }

            container.innerHTML = `
                <div class="table-wrapper">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>S·∫£n Ph·∫©m</th>
                                <th>ƒê∆°n V·ªã</th>
                                <th>T·ªìn Kho</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageProducts.map(product => {
                                const qty = pageInventory[product.id] || 0;
                                return `
                                    <tr>
                                        <td><strong>${product.name}</strong></td>
                                        <td>${product.unit}</td>
                                        <td><strong style="color: ${qty > 0 ? 'var(--success)' : 'var(--danger)'};">${qty}</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function displayLichSu() {
            const container = document.getElementById('lichsu-list');
            const pageTransactions = transactions
                .filter(t => t.page === currentPage)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (pageTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üïê</div><div class="empty-state-text">Ch∆∞a c√≥ l·ªãch s·ª≠ xu·∫•t nh·∫≠p</div></div>';
                return;
            }

            // Group transactions by date
            const groupedByDate = {};
            pageTransactions.forEach(trans => {
                const date = new Date(trans.timestamp);
                const dateKey = date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = {
                        date: date,
                        transactions: []
                    };
                }
                groupedByDate[dateKey].transactions.push(trans);
            });

            // Generate HTML with date headers
            let html = '';
            Object.keys(groupedByDate).forEach(dateKey => {
                const group = groupedByDate[dateKey];
                const date = group.date;
                
                // Format date header
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateLabel;
                if (date.toDateString() === today.toDateString()) {
                    dateLabel = 'H√¥m Nay';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    dateLabel = 'H√¥m Qua';
                } else {
                    const dayOfWeek = date.toLocaleDateString('vi-VN', { weekday: 'long' });
                    dateLabel = `${dayOfWeek}, ${dateKey}`;
                }
                
                html += `
                    <div class="date-section">
                        <div class="date-header">
                            <span class="date-icon">üìÖ</span>
                            <span>${dateLabel}</span>
                        </div>
                        <div class="date-transactions">
                `;
                
                group.transactions.forEach(trans => {
                    const product = products.find(p => p.id === trans.product_id);
                    const productName = product ? product.name : 'N/A';
                    const time = new Date(trans.timestamp).toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="list-item ${trans.type}">
                            <div class="list-item-header">
                                <div class="list-item-title">${productName}</div>
                                <div class="list-item-badge badge-${trans.type}">
                                    ${trans.type === 'nhap' ? 'üì• Nh·∫≠p v·ªÅ' : 'üì§ C·∫•p ph√°t'}
                                </div>
                            </div>
                            <div class="list-item-details">
                                <div class="list-item-detail">
                                    <span>üìä</span>
                                    <span>SL: ${trans.quantity}</span>
                                </div>
                                <div class="list-item-detail">
                                    <span>üïê</span>
                                    <span>${time}</span>
                                </div>
                                ${trans.user ? `
                                <div class="list-item-detail">
                                    <span>üë§</span>
                                    <span>${trans.user}</span>
                                </div>
                                ` : ''}
                            </div>
                            ${trans.note ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${trans.note}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayDanhMuc() {
            const container = document.getElementById('danhmuc-list');
            const pageProducts = products.filter(p => p.page === currentPage);

            if (pageProducts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</div></div>';
                return;
            }

            container.innerHTML = pageProducts.map(product => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div class="list-item-title">${product.name}</div>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="editProduct(${product.id})">‚úèÔ∏è S·ª≠a</button>
                        </div>
                    </div>
                    <div class="list-item-details">
                        <div class="list-item-detail">
                            <span>üìè</span>
                            <span>ƒê∆°n v·ªã: ${product.unit}</span>
                        </div>
                        ${product.description ? `
                        <div class="list-item-detail">
                            <span>üìù</span>
                            <span>${product.description}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displayKhuVuc() {
            const container = document.getElementById('khuvuc-list');
            const pageLocations = locations.filter(loc => loc.page === currentPage);

            if (pageLocations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìç</div><div class="empty-state-text">Ch∆∞a c√≥ khu v·ª±c n√†o</div></div>';
                return;
            }

            container.innerHTML = pageLocations.map(location => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div class="list-item-title">${location.name}</div>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="editLocation(${location.id})">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteLocation(${location.id})">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                    ${location.description ? `
                    <div class="list-item-details">
                        <div class="list-item-detail">
                            <span>üìù</span>
                            <span>${location.description}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // BƒÉng Th√¥ng Functions
        async function loadBandwidthLogs() {
            try {
                const response = await apiCall('bandwidth_logs&page=' + currentPage, 'GET');
                if (response.success) {
                    bandwidthLogs = response.data || [];
                    calculateCurrentBandwidth();
                }
            } catch (error) {
                console.error('Load bandwidth error:', error);
                logError('Load Bandwidth', error);
            }
        }

        function calculateCurrentBandwidth() {
            // T√≠nh bƒÉng th√¥ng hi·ªán t·∫°i c·ªßa t·ª´ng khu v·ª±c
            const locationMap = {};

            bandwidthLogs
                .filter(log => log.page === currentPage)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach(log => {
                    if (!locationMap[log.location]) {
                        locationMap[log.location] = {
                            location: log.location,
                            bandwidth: log.bandwidth_after,
                            lastUpdate: log.timestamp,
                            lastUser: log.user
                        };
                    }
                });

            currentBandwidth = locationMap;
        }

        function displayBandwidth() {
            displayCurrentBandwidth();
            displayBandwidthHistory();
        }

        function displayCurrentBandwidth() {
            const container = document.getElementById('current-bandwidth-list');
            const locations = Object.values(currentBandwidth);

            if (locations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì°</div><div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu bƒÉng th√¥ng</div></div>';
                return;
            }

            container.innerHTML = locations.map(loc => {
                const updateDate = loc.lastUpdate ? new Date(loc.lastUpdate).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }) : '';
                const updateTime = new Date(loc.lastUpdate).toLocaleString('vi-VN');
                return `
                    <div class="list-item" style="padding: 8px 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div>
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">${loc.location}</div>
                                ${updateDate ? `<div style="font-size: 10px; color: var(--text-tertiary);">C·∫≠p nh·∫≠t: ${updateDate}</div>` : ''}
                            </div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--primary);">
                                ${loc.bandwidth}<span style="font-size: 10px; font-weight: 500; opacity: 0.7; margin-left: 2px;">Mbps</span>
                            </div>
                        </div>
                        <div class="list-item-details">
                            <div class="list-item-detail" style="font-size: 11px;">
                                <span>‚è∞</span>
                                <span>${updateTime}</span>
                            </div>
                            <div class="list-item-detail" style="font-size: 11px;">
                                <span>üë§</span>
                                <span>${loc.lastUser}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayBandwidthHistory() {
            const container = document.getElementById('bandwidth-history-list');
            const searchTerm = document.getElementById('search-bandwidth')?.value.toLowerCase() || '';

            let pageLogs = bandwidthLogs.filter(log =>
                log.page === currentPage &&
                log.location.toLowerCase().includes(searchTerm)
            );

            if (pageLogs.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì°</div><div class="empty-state-text">Ch∆∞a c√≥ l·ªãch s·ª≠ thay ƒë·ªïi</div></div>';
                return;
            }

            // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t
            pageLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            container.innerHTML = pageLogs.map(log => {
                const time = new Date(log.timestamp).toLocaleString('vi-VN');
                const changeValue = log.bandwidth_change;
                const changeText = changeValue > 0 ? `+${changeValue}` : `${changeValue}`;
                const changeColor = changeValue > 0 ? 'var(--success)' : 'var(--danger)';

                let eventIcon, eventText;
                if (log.event_type === 'moi') {
                    eventIcon = 'üÜï';
                    eventText = 'L·∫Øp M·ªõi';
                } else if (log.event_type === 'tang') {
                    eventIcon = 'üìà';
                    eventText = 'TƒÉng';
                } else if (log.event_type === 'giam') {
                    eventIcon = 'üìâ';
                    eventText = 'Gi·∫£m';
                } else {
                    eventIcon = 'üìù';
                    eventText = 'Kh√°c';
                }

                return `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${log.location}</div>
                            <div class="list-item-badge" style="background: ${changeColor};">
                                ${eventIcon} ${eventText}
                            </div>
                        </div>
                        <div class="list-item-details">
                            <div class="list-item-detail">
                                <span>üìä</span>
                                <span>Thay ƒë·ªïi: <strong style="color: ${changeColor};">${changeText} Mbps</strong></span>
                            </div>
                            <div class="list-item-detail">
                                <span>üì°</span>
                                <span>Sau: <strong>${log.bandwidth_after} Mbps</strong></span>
                            </div>
                            <div class="list-item-detail">
                                <span>‚è∞</span>
                                <span>${time}</span>
                            </div>
                            <div class="list-item-detail">
                                <span>üë§</span>
                                <span>${log.user}</span>
                            </div>
                            ${log.note ? `
                            <div class="list-item-detail" style="grid-column: 1 / -1;">
                                <span>üìù</span>
                                <span>${log.note}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function handleBandwidthSubmit(e) {
            e.preventDefault();

            const location = document.getElementById('bt-location').value.trim();
            const eventType = document.getElementById('bt-event-type').value;
            const changeValue = parseFloat(document.getElementById('bt-change').value);
            const after = parseFloat(document.getElementById('bt-after').value);
            const note = document.getElementById('bt-note').value.trim();

            if (!location || !eventType || isNaN(changeValue) || isNaN(after)) {
                showToast('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            // T·ª± ƒë·ªông th√™m d·∫•u +/- d·ª±a v√†o event type
            let actualChange = 0;
            if (eventType === 'moi') {
                actualChange = Math.abs(changeValue);
            } else if (eventType === 'tang') {
                actualChange = Math.abs(changeValue);
            } else if (eventType === 'giam') {
                actualChange = -Math.abs(changeValue);
            }

            showLoading();

            try {
                const data = {
                    page: currentPage,
                    location: location,
                    event_type: eventType,
                    bandwidth_change: actualChange, // L∆∞u v·ªõi d·∫•u ƒë√∫ng
                    bandwidth_after: after,
                    note: note,
                    user: currentUser
                };

                const response = await apiCall('bandwidth_logs', 'POST', data);

                if (response.success) {
                    showToast('success', 'C·∫≠p nh·∫≠t bƒÉng th√¥ng th√†nh c√¥ng!');
                    document.getElementById('form-bangthong').reset();
                    await loadBandwidthLogs();
                    displayBandwidth();
                } else {
                    showToast('error', response.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Bandwidth Submit Error', error);
            } finally {
                hideLoading();
            }
        }

        function filterBandwidth() {
            displayBandwidthHistory();
        }

        // Filter Functions
        function filterTonKho() {
            const searchTerm = document.getElementById('search-tonkho').value.toLowerCase();
            const pageProducts = products.filter(p =>
                p.page === currentPage && p.name.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('tonkho-list');
            const pageInventory = inventory[currentPage] || {};

            if (pageProducts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div></div>';
                return;
            }

            container.innerHTML = `
                <div class="table-wrapper">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>S·∫£n Ph·∫©m</th>
                                <th>ƒê∆°n V·ªã</th>
                                <th>T·ªìn Kho</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageProducts.map(product => {
                                const qty = pageInventory[product.id] || 0;
                                return `
                                    <tr>
                                        <td><strong>${product.name}</strong></td>
                                        <td>${product.unit}</td>
                                        <td><strong style="color: ${qty > 0 ? 'var(--success)' : 'var(--danger)'};">${qty}</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function filterLichSu() {
            const searchTerm = document.getElementById('search-lichsu').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;
            
            let filtered = transactions.filter(t => t.page === currentPage);
            
            if (filterType) {
                filtered = filtered.filter(t => t.type === filterType);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(t => {
                    const product = products.find(p => p.id === t.product_id);
                    return product && product.name.toLowerCase().includes(searchTerm);
                });
            }

            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const container = document.getElementById('lichsu-list');

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">Kh√¥ng t√¨m th·∫•y</div></div>';
                return;
            }

            // Group by date
            const groupedByDate = {};
            filtered.forEach(trans => {
                const date = new Date(trans.timestamp);
                const dateKey = date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = {
                        date: date,
                        transactions: []
                    };
                }
                groupedByDate[dateKey].transactions.push(trans);
            });

            // Generate HTML with date headers
            let html = '';
            Object.keys(groupedByDate).forEach(dateKey => {
                const group = groupedByDate[dateKey];
                const date = group.date;
                
                // Format date header
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateLabel;
                if (date.toDateString() === today.toDateString()) {
                    dateLabel = 'H√¥m Nay';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    dateLabel = 'H√¥m Qua';
                } else {
                    const dayOfWeek = date.toLocaleDateString('vi-VN', { weekday: 'long' });
                    dateLabel = `${dayOfWeek}, ${dateKey}`;
                }
                
                html += `
                    <div class="date-section">
                        <div class="date-header">
                            <span class="date-icon">üìÖ</span>
                            <span>${dateLabel}</span>
                        </div>
                        <div class="date-transactions">
                `;
                
                group.transactions.forEach(trans => {
                    const product = products.find(p => p.id === trans.product_id);
                    const productName = product ? product.name : 'N/A';
                    const time = new Date(trans.timestamp).toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="list-item ${trans.type}">
                            <div class="list-item-header">
                                <div class="list-item-title">${productName}</div>
                                <div class="list-item-badge badge-${trans.type}">
                                    ${trans.type === 'nhap' ? 'üì• Nh·∫≠p v·ªÅ' : 'üì§ C·∫•p ph√°t'}
                                </div>
                            </div>
                            <div class="list-item-details">
                                <div class="list-item-detail">
                                    <span>üìä</span>
                                    <span>SL: ${trans.quantity}</span>
                                </div>
                                <div class="list-item-detail">
                                    <span>üïê</span>
                                    <span>${time}</span>
                                </div>
                            </div>
                            ${trans.note ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${trans.note}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Export to Excel/CSV Function
        function exportExcel() {
            try {
                // Check if on mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // Mobile: Export as CSV (works better on mobile)
                    exportCSV();
                } else {
                    // Desktop: Export as Excel
                    exportExcelFile();
                }
            } catch (error) {
                showToast('error', 'L·ªói export: ' + error.message);
                logError('Export Error', error);
            }
        }
        
        function exportExcelFile() {
            // Prepare Sheet 1 - T·ªìn Kho
            const pageInventory = inventory[currentPage] || {};
            const tonkhoData = [['S·∫£n Ph·∫©m', 'ƒê∆°n V·ªã', 'T·ªìn Kho', 'Page']];
            
            products.forEach(product => {
                if (product.page === currentPage) {
                    const qty = pageInventory[product.id] || 0;
                    tonkhoData.push([product.name, product.unit, qty, product.page]);
                }
            });
            
            // Prepare Sheet 2 - L·ªãch S·ª≠
            const lichsuData = [['Ng√†y Gi·ªù', 'Lo·∫°i', 'S·∫£n Ph·∫©m', 'S·ªë L∆∞·ª£ng', 'Ng∆∞·ªùi', 'Ghi Ch√∫', 'Page']];
            
            const pageTransactions = transactions
                .filter(t => t.page === currentPage)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
            pageTransactions.forEach(trans => {
                const product = products.find(p => p.id === trans.product_id);
                const time = new Date(trans.timestamp).toLocaleString('vi-VN');
                const type = trans.type === 'nhap' ? 'Nh·∫≠p v·ªÅ' : 'C·∫•p ph√°t';
                
                lichsuData.push([
                    time,
                    type,
                    product ? product.name : 'N/A',
                    trans.quantity,
                    trans.user || 'N/A',
                    trans.note || '',
                    trans.page
                ]);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.aoa_to_sheet(tonkhoData);
            const ws2 = XLSX.utils.aoa_to_sheet(lichsuData);
            
            ws1['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 12 }, { wch: 10 }];
            ws2['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 30 }, { wch: 12 }, { wch: 20 }, { wch: 40 }, { wch: 10 }];
            
            XLSX.utils.book_append_sheet(wb, ws1, 'T·ªìn Kho');
            XLSX.utils.book_append_sheet(wb, ws2, 'L·ªãch S·ª≠');
            
            const now = new Date();
            const filename = `XuatNhapHang_${currentPage}_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showToast('success', 'ƒê√£ export Excel th√†nh c√¥ng!');
        }
        
        function exportCSV() {
            let csv = 'T·ªíN KHO\n';
            csv += 'S·∫£n Ph·∫©m,ƒê∆°n V·ªã,T·ªìn Kho,Page\n';
            
            const pageInventory = inventory[currentPage] || {};
            products.forEach(product => {
                if (product.page === currentPage) {
                    const qty = pageInventory[product.id] || 0;
                    csv += `${product.name},${product.unit},${qty},${product.page}\n`;
                }
            });
            
            csv += '\nL·ªäCH S·ª¨ XU·∫§T NH·∫¨P\n';
            csv += 'Ng√†y Gi·ªù,Lo·∫°i,S·∫£n Ph·∫©m,S·ªë L∆∞·ª£ng,Ng∆∞·ªùi,Ghi Ch√∫,Page\n';
            
            const pageTransactions = transactions
                .filter(t => t.page === currentPage)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
            pageTransactions.forEach(trans => {
                const product = products.find(p => p.id === trans.product_id);
                const time = new Date(trans.timestamp).toLocaleString('vi-VN');
                const type = trans.type === 'nhap' ? 'Nh·∫≠p v·ªÅ' : 'C·∫•p ph√°t';
                
                csv += `${time},${type},${product ? product.name : 'N/A'},${trans.quantity},${trans.user || 'N/A'},"${trans.note || ''}",${trans.page}\n`;
            });
            
            // Create and download
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const filename = `XuatNhapHang_${currentPage}_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.csv`;
            
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('success', 'ƒê√£ export CSV th√†nh c√¥ng!');
        }

        // Modal Functions
        function openProductModal(productId = null) {
            const modal = document.getElementById('modal-product');
            const title = document.getElementById('modal-product-title');
            const form = document.getElementById('form-product');
            
            // Reset form COMPLETELY
            form.reset();
            document.getElementById('product-id').value = ''; // Clear hidden ID field
            
            if (productId) {
                // Edit mode - c√≥ ID
                const product = products.find(p => p.id === productId);
                if (product) {
                    title.textContent = 'S·ª≠a S·∫£n Ph·∫©m';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-unit').value = product.unit;
                    document.getElementById('product-description').value = product.description || '';
                }
            } else {
                // Add mode - KH√îNG ID
                title.textContent = 'Th√™m S·∫£n Ph·∫©m';
                document.getElementById('product-id').value = ''; // Ensure empty
            }
            
            modal.classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');

            // Reset form khi ƒë√≥ng ƒë·ªÉ clear ID c≈©
            if (modalId === 'modal-product') {
                const form = document.getElementById('form-product');
                if (form) {
                    form.reset();
                    document.getElementById('product-id').value = ''; // Clear ID
                }
            }

            if (modalId === 'modal-location') {
                const form = document.getElementById('form-location');
                if (form) {
                    form.reset();
                    document.getElementById('location-id').value = ''; // Clear ID
                }
            }
        }

        function editProduct(productId) {
            openProductModal(productId);
        }

        // UI Helper Functions
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const messageEl = document.getElementById('toast-message');
            
            toast.className = 'toast show toast-' + type;
            
            // Set icon
            switch(type) {
                case 'success':
                    icon.textContent = '‚úÖ';
                    break;
                case 'error':
                    icon.textContent = '‚ùå';
                    break;
                case 'info':
                    icon.textContent = '‚ÑπÔ∏è';
                    break;
            }
            
            // Clean message - remove duplicate emoji
            const cleanMessage = message.replace(/^[‚úÖ‚ùå‚ÑπÔ∏è]\s*/, '');
            messageEl.textContent = cleanMessage;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Error Logging
        function logError(context, error) {
            const errorLog = {
                context: context,
                message: error.message,
                stack: error.stack,
                timestamp: new Date().toISOString(),
                page: currentPage,
                user: tg?.initDataUnsafe?.user?.username || 'demo_user',
            };
            
            console.error('Error Log:', errorLog);
            
            // Send to n8n for logging
            fetch(`${CONFIG.N8N_WEBHOOK_URL}?endpoint=log`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(errorLog),
            }).catch(() => {}); // Silent fail for logging
        }

        // Setup modal listeners (called after DOM ready and authorized)
        function setupModalListeners() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }
        
        // ===== GOOGLE SHEET SYNC FUNCTIONS =====
        
        async function syncToGoogleSheet() {
            const modal = document.getElementById('modal-gsheet-sync');
            const progressDiv = document.getElementById('sync-progress');
            const resultDiv = document.getElementById('sync-result');
            const errorDiv = document.getElementById('sync-error');
            
            // Show modal with progress
            modal.classList.add('active');
            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Save current page
            const originalPage = currentPage;
            
            try {
                // Update sync message
                document.getElementById('sync-message').textContent = 'ƒêang t·∫£i d·ªØ li·ªáu c·∫£ 3 trang...';
                
                // Load data for ALL 3 pages
                const allPages = ['RR88', 'XX88', 'MM88'];
                const allProductsData = [];
                const allTransactionsData = [];
                
                for (let i = 0; i < allPages.length; i++) {
                    const page = allPages[i];
                    
                    // Update progress
                    document.getElementById('sync-message').textContent = `ƒêang t·∫£i ${page}... (${i+1}/3)`;
                    
                    // Temporarily switch to this page
                    currentPage = page;
                    
                    // Load products for this page
                    const productsResponse = await apiCall('products', 'GET');
                    if (productsResponse.success) {
                        allProductsData.push(...(productsResponse.data || []));
                    }
                    
                    // Load transactions for this page
                    const transactionsResponse = await apiCall('transactions', 'GET');
                    if (transactionsResponse.success) {
                        allTransactionsData.push(...(transactionsResponse.data || []));
                    }
                    
                    // Load/calculate inventory for this page
                    const inventoryResponse = await apiCall('inventory', 'GET');
                    if (inventoryResponse.success) {
                        if (!inventory[page]) {
                            inventory[page] = {};
                        }
                        const data = inventoryResponse.data || [];
                        data.forEach(item => {
                            inventory[page][item.product_id] = item.quantity;
                        });
                    }
                }
                
                // Restore original page
                currentPage = originalPage;
                
                // Update global data v·ªõi full data
                const originalProducts = products;
                const originalTransactions = transactions;
                
                products = allProductsData;
                transactions = allTransactionsData;
                
                // Update sync message
                document.getElementById('sync-message').textContent = 'ƒêang ƒë·ªìng b·ªô l√™n Google Sheets...';
                
                // Prepare data for all 3 pages
                const syncData = prepareSyncData();
                
                console.log('[GSheet Sync] Sending data:', syncData);
                
                // Call n8n workflow
                const response = await apiCall('sync_gsheet', 'POST', syncData);
                
                console.log('[GSheet Sync] Response:', response);
                
                if (response.success && response.spreadsheetUrl) {
                    // Show success result
                    progressDiv.style.display = 'none';
                    resultDiv.style.display = 'block';
                    
                    // Set Google Sheet URL
                    document.getElementById('gsheet-url').value = response.spreadsheetUrl;
                    
                    showToast('success', 'ƒê·ªìng b·ªô Google Sheets th√†nh c√¥ng!');
                } else {
                    throw new Error(response.message || 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL t·ª´ server');
                }
            } catch (error) {
                // Restore original page on error
                currentPage = originalPage;
                
                // Show error
                progressDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                
                const errorMsg = document.getElementById('sync-error-message');
                errorMsg.textContent = error.message || 'ƒê√£ x·∫£y ra l·ªói khi ƒë·ªìng b·ªô';
                
                showToast('error', 'L·ªói ƒë·ªìng b·ªô: ' + error.message);
                logError('Google Sheet Sync Error', error);
            }
        }
        
        function prepareSyncData() {
            // Chu·∫©n b·ªã data cho c·∫£ 3 pages
            const allPages = ['RR88', 'XX88', 'MM88'];
            const inventoryData = {};
            
            // Get inventory for each page
            allPages.forEach(page => {
                const pageProducts = products.filter(p => p.page === page);
                const pageInventory = inventory[page] || {};
                
                inventoryData[page] = pageProducts.map(product => ({
                    id: product.id,
                    name: product.name,
                    unit: product.unit,
                    quantity: pageInventory[product.id] || 0,
                    description: product.description || ''
                }));
            });
            
            // Get all transactions (all pages)
            const allTransactions = transactions
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(trans => {
                    const product = products.find(p => p.id === trans.product_id);
                    return {
                        id: trans.id,
                        timestamp: new Date(trans.timestamp).toLocaleString('vi-VN'),
                        page: trans.page,
                        type: trans.type === 'nhap' ? 'Nh·∫≠p v·ªÅ' : 'C·∫•p ph√°t',
                        product_id: trans.product_id,
                        product: product ? product.name : 'N/A',
                        quantity: trans.quantity,
                        user: trans.user || 'N/A',
                        note: trans.note || ''
                    };
                });
            
            return {
                inventory: inventoryData,
                transactions: allTransactions,
                sync_time: new Date().toISOString(),
                synced_by: currentUser
            };
        }
        
        function copyGSheetLink() {
            const input = document.getElementById('gsheet-url');
            if (input) {
                input.select();
                input.setSelectionRange(0, 99999); // Mobile
                
                try {
                    document.execCommand('copy');
                    showToast('success', 'ƒê√£ copy link!');
                } catch (err) {
                    // Fallback for modern browsers
                    navigator.clipboard.writeText(input.value).then(() => {
                        showToast('success', 'ƒê√£ copy link!');
                    }).catch(() => {
                        showToast('error', 'Kh√¥ng th·ªÉ copy link');
                    });
                }
            }
        }
        
        function openGSheet() {
            const url = document.getElementById('gsheet-url').value;
            if (url) {
                // Use Telegram WebApp openLink if available
                if (tg && tg.openLink) {
                    tg.openLink(url);
                } else {
                    // Fallback to window.open
                    window.open(url, '_blank');
                }
            }
        }
        
        // ===== BULK IMPORT/EXPORT FUNCTIONS =====
        
        let bulkNhapItems = [];
        let bulkXuatItems = [];
        
        function addBulkNhapRow() {
            const pageProducts = products.filter(p => p.page === currentPage);
            if (pageProducts.length === 0) {
                showToast('error', 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!');
                return;
            }
            
            const id = Date.now();
            bulkNhapItems.push({
                id: id,
                product_id: null,
                quantity: 1
            });
            
            renderBulkNhapList();
        }
        
        function addBulkXuatRow() {
            const pageProducts = products.filter(p => p.page === currentPage);
            if (pageProducts.length === 0) {
                showToast('error', 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!');
                return;
            }
            
            const id = Date.now();
            bulkXuatItems.push({
                id: id,
                product_id: null,
                quantity: 1
            });
            
            renderBulkXuatList();
        }
        
        function removeBulkNhapItem(id) {
            bulkNhapItems = bulkNhapItems.filter(item => item.id !== id);
            renderBulkNhapList();
        }
        
        function removeBulkXuatItem(id) {
            bulkXuatItems = bulkXuatItems.filter(item => item.id !== id);
            renderBulkXuatList();
        }
        
        function updateBulkNhapItem(id, field, value) {
            const item = bulkNhapItems.find(i => i.id === id);
            if (item) {
                item[field] = field === 'product_id' ? parseInt(value) : parseInt(value);
            }
            renderBulkNhapList();
        }
        
        function updateBulkXuatItem(id, field, value) {
            const item = bulkXuatItems.find(i => i.id === id);
            if (item) {
                item[field] = field === 'product_id' ? parseInt(value) : parseInt(value);
            }
            renderBulkXuatList();
        }
        
        function renderBulkNhapList() {
            const container = document.getElementById('bulk-nhap-list');
            const pageProducts = products.filter(p => p.page === currentPage);
            const pageInventory = inventory[currentPage] || {};
            
            if (bulkNhapItems.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="empty-state-text" style="font-size: 14px;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. Click "Th√™m S·∫£n Ph·∫©m" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div></div>';
                document.getElementById('bulk-nhap-count').textContent = '0';
                return;
            }
            
            container.innerHTML = bulkNhapItems.map(item => `
                <div class="bulk-item">
                    <select class="form-control" onchange="updateBulkNhapItem(${item.id}, 'product_id', this.value)">
                        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        ${pageProducts.map(p => {
                            const qty = pageInventory[p.id] || 0;
                            const stockText = qty > 0 ? `c√≤n: ${qty}` : 'h·∫øt h√†ng';
                            return `<option value="${p.id}" ${item.product_id === p.id ? 'selected' : ''}>${p.name} (${stockText})</option>`;
                        }).join('')}
                    </select>
                    <div class="bulk-item-quantity">
                        <span style="font-size: 13px; color: var(--text-secondary);">SL:</span>
                        <input type="number" class="bulk-qty-input" value="${item.quantity}" min="1" onchange="updateBulkNhapItem(${item.id}, 'quantity', this.value)">
                    </div>
                    <button class="bulk-remove-btn" onclick="removeBulkNhapItem(${item.id})">üóëÔ∏è</button>
                </div>
            `).join('');
            
            document.getElementById('bulk-nhap-count').textContent = bulkNhapItems.length;
        }
        
        function renderBulkXuatList() {
            const container = document.getElementById('bulk-xuat-list');
            const pageProducts = products.filter(p => p.page === currentPage);
            const pageInventory = inventory[currentPage] || {};
            
            if (bulkXuatItems.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="empty-state-text" style="font-size: 14px;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. Click "Th√™m S·∫£n Ph·∫©m" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div></div>';
                document.getElementById('bulk-xuat-count').textContent = '0';
                return;
            }
            
            container.innerHTML = bulkXuatItems.map(item => {
                const currentInv = item.product_id ? (pageInventory[item.product_id] || 0) : 0;
                return `
                    <div class="bulk-item">
                        <select class="form-control" onchange="updateBulkXuatItem(${item.id}, 'product_id', this.value)">
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            ${pageProducts.map(p => {
                                const inv = pageInventory[p.id] || 0;
                                const stockText = inv > 0 ? `c√≤n: ${inv}` : 'h·∫øt h√†ng';
                                return `<option value="${p.id}" ${item.product_id === p.id ? 'selected' : ''}>${p.name} (${stockText})</option>`;
                            }).join('')}
                        </select>
                        <div class="bulk-item-quantity">
                            <span style="font-size: 13px; color: var(--text-secondary);">SL:</span>
                            <input type="number" class="bulk-qty-input" value="${item.quantity}" min="1" max="${currentInv}" onchange="updateBulkXuatItem(${item.id}, 'quantity', this.value)">
                        </div>
                        <button class="bulk-remove-btn" onclick="removeBulkXuatItem(${item.id})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
            
            document.getElementById('bulk-xuat-count').textContent = bulkXuatItems.length;
        }
        
        async function handleBulkNhap() {
            if (bulkNhapItems.length === 0) {
                showToast('error', 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!');
                return;
            }
            
            // Validate all items
            for (const item of bulkNhapItems) {
                if (!item.product_id || !item.quantity) {
                    showToast('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return;
                }
            }
            
            const commonNote = document.getElementById('bulk-nhap-note').value;
            
            try {
                showLoading();
                let successCount = 0;
                let failCount = 0;
                
                // Process each item sequentially (gi·ªØ c·∫•u tr√∫c data hi·ªán t·∫°i)
                for (const item of bulkNhapItems) {
                    try {
                        const product = products.find(p => p.id === item.product_id);
                        const note = commonNote ? `${commonNote} - ${product?.name}` : product?.name;
                        
                        const response = await apiCall('transactions', 'POST', {
                            type: 'nhap',
                            product_id: item.product_id,
                            quantity: item.quantity,
                            note: note,
                        });
                        
                        if (response.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                        console.error('Bulk nhap item error:', error);
                    }
                }
                
                // Reload data
                await loadTransactions();
                await loadInventory();
                updateDashboard();
                
                // Clear bulk list
                bulkNhapItems = [];
                renderBulkNhapList();
                document.getElementById('bulk-nhap-note').value = '';
                
                showToast('success', `‚úÖ Nh·∫≠p ${successCount} s·∫£n ph·∫©m th√†nh c√¥ng${failCount > 0 ? `, ${failCount} th·∫•t b·∫°i` : ''}!`);
                
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Bulk Nhap Error', error);
            } finally {
                hideLoading();
            }
        }
        
        async function handleBulkXuat() {
            if (bulkXuatItems.length === 0) {
                showToast('error', 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!');
                return;
            }
            
            // Validate all items
            for (const item of bulkXuatItems) {
                if (!item.product_id || !item.quantity) {
                    showToast('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return;
                }
                
                // Check inventory
                const currentInv = inventory[currentPage]?.[item.product_id] || 0;
                if (currentInv < item.quantity) {
                    const product = products.find(p => p.id === item.product_id);
                    showToast('error', `Kh√¥ng ƒë·ªß h√†ng: ${product?.name} (TK: ${currentInv})`);
                    return;
                }
            }
            
            const commonNote = document.getElementById('bulk-xuat-note').value;
            
            try {
                showLoading();
                let successCount = 0;
                let failCount = 0;
                
                // Process each item sequentially (gi·ªØ c·∫•u tr√∫c data hi·ªán t·∫°i)
                for (const item of bulkXuatItems) {
                    try {
                        const product = products.find(p => p.id === item.product_id);
                        const note = commonNote ? `${commonNote} - ${product?.name}` : product?.name;
                        
                        const response = await apiCall('transactions', 'POST', {
                            type: 'xuat',
                            product_id: item.product_id,
                            quantity: item.quantity,
                            note: note,
                        });
                        
                        if (response.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                        console.error('Bulk xuat item error:', error);
                    }
                }
                
                // Reload data
                await loadTransactions();
                await loadInventory();
                updateDashboard();
                
                // Clear bulk list
                bulkXuatItems = [];
                renderBulkXuatList();
                document.getElementById('bulk-xuat-note').value = '';
                
                showToast('success', `‚úÖ Xu·∫•t ${successCount} s·∫£n ph·∫©m th√†nh c√¥ng${failCount > 0 ? `, ${failCount} th·∫•t b·∫°i` : ''}!`);
                
            } catch (error) {
                showToast('error', 'L·ªói: ' + error.message);
                logError('Bulk Xuat Error', error);
            } finally {
                hideLoading();
            }
        }
        
        // ===== BULK/SINGLE SWITCH FUNCTIONS =====
        
        function switchToBulkNhap() {
            showSection('nhap-bulk');
            // Auto add first row if empty
            if (bulkNhapItems.length === 0) {
                addBulkNhapRow();
            }
        }
        
        function switchToBulkXuat() {
            showSection('xuat-bulk');
            // Auto add first row if empty
            if (bulkXuatItems.length === 0) {
                addBulkXuatRow();
            }
        }
        
        function switchToSingleNhap() {
            showSection('nhap');
        }
        
        function switchToSingleXuat() {
            showSection('xuat');
        }
        
        // Call when authorized
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // Wait for init, will be called in setupEventListeners if authorized
            });
        }

        // Configuration
        const CONFIG = {
            N8N_WEBHOOK_URL: 'https://n8n.tayninh.cloud/webhook',
            API_PATH: 'api',
        };

        // Global State
        let currentPage = 'RR88';
        let currentSection = 'dashboard';
        let products = [];
        let transactions = [];
        let inventory = {};
        let allowedPages = [];
        let locations = [];
        let bandwidthLogs = [];
        let currentBandwidth = {};

        // Dashboard State
        let currentTimeFilter = 'week';
        let chartInstance = null;
        let currentChartType = 'bar';
        let dashboardData = null;

        // Telegram WebApp
        let tg = window.Telegram?.WebApp;
        let currentUser = 'Unknown';
        let currentUserId = null;
        
        if (tg) {
            tg.ready();

            const mode = tg.initDataUnsafe?.start_param || 'full';

            switch (mode) {
                case 'compact':
                    tg.setHeaderColor('secondary_bg_color');
                    tg.disableClosingConfirmation();
                    break;

                case 'full':
                    tg.expand();
                    tg.setHeaderColor('bg_color');
                    break;

                case 'fullscreen':
                    if (tg.requestFullscreen) {
                        tg.requestFullscreen();
                    } else {
                        tg.expand();
                    }
                    break;
            }

            tg.MainButton.hide();
            
            const user = tg.initDataUnsafe?.user;
            if (user) {
                currentUser = user.first_name || user.username || 'Unknown';
                currentUserId = user.id;
            }
            
            const theme = tg.colorScheme || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            
            tg.onEvent('themeChanged', function() {
                document.documentElement.setAttribute('data-theme', tg.colorScheme);
            });
        }

        // [COPY TO√ÄN B·ªò PH·∫¶N JAVASCRIPT C√íN L·∫†I T·ª™ FILE G·ªêC]
        // T·∫•t c·∫£ functions t·ª´ initializeApp() ƒë·∫øn h·∫øt file
    </script>
</body>
</html>